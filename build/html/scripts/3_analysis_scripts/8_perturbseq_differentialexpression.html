

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Differential Expression analysis between P1 &amp; P2 &mdash; Isoform Specific Perturb-Seq  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cell Assignment Model from FUCCI-Matched Single-Cell Paper" href="7_cellphase_model.html" />
    <link rel="prev" title="Quantitative individual UMAPs per gene of interest" href="6_perturbseq_tsne_kldivergence_umap.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Isoform Specific Perturb-Seq
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Analysis Pipeline:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../promoter_identification.html">Promoter Identification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_design.html">Promoter Specific Guide Design</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../analysis_scripts.html">Analysis Scripts &amp; Pipelines</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#preprocessing-guide-calling">Preprocessing &amp; Guide Calling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#transcript-quantification">Transcript Quantification</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../analysis_scripts.html#transcriptional-divergence-e-stats-differential-expression">Transcriptional Divergence (E-Stats &amp; Differential Expression)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="4_estatistic_gene_guide.html">Guide Calling Using the Cellranger Module HDF5 File</a></li>
<li class="toctree-l3"><a class="reference internal" href="5_genekd_neighbouring_gene_expression.html">Target gene and neighbouring gene expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="6_perturbseq_tsne_kldivergence_umap.html">Quantitative individual UMAPs per gene of interest</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Differential Expression analysis between P1 &amp; P2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#cell-phase-pathway-modeling">Cell Phase &amp; Pathway Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#clinical-promoter-prevalence">Clinical &amp; Promoter Prevalence</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Isoform Specific Perturb-Seq</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../analysis_scripts.html">Analysis Scripts &amp; Pipelines</a></li>
      <li class="breadcrumb-item active">Differential Expression analysis between P1 &amp; P2</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/scripts/3_analysis_scripts/8_perturbseq_differentialexpression.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Differential-Expression-analysis-between-P1-&amp;-P2">
<h1>Differential Expression analysis between P1 &amp; P2<a class="headerlink" href="#Differential-Expression-analysis-between-P1-&-P2" title="Link to this heading">ÔÉÅ</a></h1>
<ol class="arabic simple">
<li><p>Run through the 10x Cellranger pipeline and velocyto for single cell RNAseq quatification and using (2) guides quantifiction. all found in the cellranger files folder <strong>bash</strong></p></li>
<li><p>Guide Calling for dual guide. Use repogle method to take molecule.h5 generated by cellranger and py to run through repogle version of guide calling or use cellranger_guidecalling.ipynb for Direct Capture Perturb-Seq dual guide. Formed guide-specific lists of cells.</p></li>
<li><p>Pseudobulk analysis. A. Seperation of guide-specific fastq files. <strong>bash</strong> B. Whippet pseudobulk for transcript specific analysis, post UMI deduplication. <strong>bash</strong> C. Transcript quality control. <strong>R</strong> D. Whippet result visualisation.</p></li>
<li><p>Normalisation of adata object and E-distance of KD</p></li>
<li><p>Check gene and neighboring gene expression</p></li>
<li><p>Create individual umaps per gene of interest A. UMAPs B. Rand Index score</p></li>
<li><p>Cell phase assignment model from FUCCI-matched single cell paper (GSE146773)</p></li>
<li><p><strong>Differential Expression analysis.</strong> A. Find the shared P1 and P2 genes. B. Check the shared P1 and P2 across different protospacers with the same A/B and C/D.</p></li>
<li><p>CNV Score &amp; Numbat to quantify and Velocity quantification with loom file</p></li>
<li><p>ESR1-specific analysis from proliferation analysis to rt-qpcr</p></li>
<li><p>Spectra analysis and visualisation for pathway enrichment</p></li>
</ol>
<p>It performs the Systematic Differential Expression (DE) Analysis requested by reviewers to quantify and compare the transcriptional effects of P1 and P2 promoter knockdowns. The notebook identifies which genes change significantly in expression following the knockdown of a specific promoter compared to non-targeting controls (NTC).</p>
<p>Methodology: It utilizes the scanpy.tl.rank_genes_groups function, applying a t-test or Mann-Whitney U test (Z-score) to identify differentially expressed genes (DEGs).</p>
<p>Filtering Criteria: DEGs are strictly filtered based on a <span class="math notranslate nohighlight">\(log_{2}FC &gt; 0.5\)</span>, an adjusted p-value <span class="math notranslate nohighlight">\(&lt; 0.05\)</span>, and a requirement that the gene is expressed in <span class="math notranslate nohighlight">\(&gt; 10\%\)</span> of the cells in the perturbed population.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="c1">#general</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ad</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hdf5plugin</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gseapy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gp</span>

<span class="c1">#form a location</span>
<span class="n">loc</span><span class="o">=</span><span class="s2">&quot;../alt-prom-crispr-fiveprime/&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scperturb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;scripts/&#39;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">apu_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scperturb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">infercnvpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cnv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">apu_analysis.cell_import</span><span class="w"> </span><span class="kn">import</span> <span class="n">CellPopulation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1">#for this python</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">rel_entr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cluster</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">umap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootstrap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.multitest</span><span class="w"> </span><span class="kn">import</span> <span class="n">multipletests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">reshape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">array</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">ttest_ind</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.stats.multitest</span><span class="w"> </span><span class="kn">import</span> <span class="n">multipletests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">mannwhitneyu</span>

<span class="c1"># Taken from:</span>
<span class="c1"># Adamson, B.A., Norman, T.M., *et al.* &quot;A multiplexed CRISPR screening platform enables systematic dissection of the unfolded protein response&quot;, *Cell*, 2016.</span>
<span class="c1"># My experiment deals with two KDs- one of the MP, one of the AP using two guides. Positve controls include GINS1 ect. This is a combnatorial KD double for the same gene. No treatments were used</span>

<span class="c1"># colours using garvan</span>
<span class="n">color1</span> <span class="o">=</span><span class="s1">&#39;#4d00c7&#39;</span>
<span class="n">palecolor1</span><span class="o">=</span><span class="s2">&quot;#b366ff&quot;</span>
<span class="n">color2</span><span class="o">=</span> <span class="s1">&#39;#da3c07&#39;</span>
<span class="n">palecolor2</span><span class="o">=</span><span class="s2">&quot;#ff8954&quot;</span>
<span class="n">color3</span><span class="o">=</span><span class="s1">&#39;#05d3d3&#39;</span>
<span class="n">color4</span><span class="o">=</span><span class="s1">&#39;#c6c7c5&#39;</span>
<span class="n">color4</span><span class="o">=</span><span class="s2">&quot;#434541&quot;</span>
<span class="n">color5</span><span class="o">=</span><span class="s2">&quot;#eb31e1&quot;</span>
<span class="n">color6</span><span class="o">=</span><span class="s2">&quot;#3175eb&quot;</span>
<span class="n">color7</span><span class="o">=</span><span class="s2">&quot;#a7eb31&quot;</span>
<span class="n">color8</span><span class="o">=</span><span class="s2">&quot;#b366ff&quot;</span>
<span class="n">color9</span><span class="o">=</span><span class="s2">&quot;#ff8954&quot;</span>
<span class="n">color10</span><span class="o">=</span><span class="s2">&quot;#35c9d4&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_gsea_for_gene</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gene</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>

    <span class="n">gene_AP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_AP&quot;</span>
    <span class="n">gene_MP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_MP&quot;</span>

    <span class="c1"># ---------- MP GUIDE ----------</span>
    <span class="c1"># get full DE table (NO pval/logFC cutoff for GSEA)</span>
    <span class="n">MP_rank</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_MP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># make a 2-column ranking like your STIM example:</span>
    <span class="c1">#   [names, logfoldchanges]</span>
    <span class="n">mp_rnk</span> <span class="o">=</span> <span class="n">MP_rank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># run prerank</span>
    <span class="n">pre_res_mp</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">prerank</span><span class="p">(</span>
        <span class="n">rnk</span><span class="o">=</span><span class="n">mp_rnk</span><span class="p">,</span>                 <span class="c1"># DataFrame with [gene, score]</span>
        <span class="n">gene_sets</span><span class="o">=</span><span class="s2">&quot;GO_Biological_Process_2021&quot;</span><span class="p">,</span>      <span class="c1"># or your favourite collection</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                <span class="c1"># don&#39;t write files</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">123</span>
    <span class="p">)</span>

    <span class="c1"># grab the result table</span>
    <span class="n">mp_res_df</span> <span class="o">=</span> <span class="n">pre_res_mp</span><span class="o">.</span><span class="n">res2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_MP</span>
    <span class="c1"># classify direction by NES sign</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span>
    <span class="n">gsea_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp_res_df</span><span class="p">)</span>

    <span class="c1"># ---------- AP GUIDE ----------</span>
    <span class="n">AP_rank</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_AP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ap_rnk</span> <span class="o">=</span> <span class="n">AP_rank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">pre_res_ap</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">prerank</span><span class="p">(</span>
        <span class="n">rnk</span><span class="o">=</span><span class="n">ap_rnk</span><span class="p">,</span>
        <span class="n">gene_sets</span><span class="o">=</span><span class="s2">&quot;GO_Biological_Process_2021&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">123</span>
    <span class="p">)</span>

    <span class="n">ap_res_df</span> <span class="o">=</span> <span class="n">pre_res_ap</span><span class="o">.</span><span class="n">res2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_AP</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span>
    <span class="c1">#add together ap_ res_df and mp_res_df</span>
    <span class="n">combined_res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mp_res_df</span><span class="p">,</span> <span class="n">ap_res_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined_res_df</span> <span class="p">,</span><span class="n">pre_res_ap</span><span class="p">,</span> <span class="n">pre_res_mp</span>

<span class="n">FDR</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">LOG_FOLD_CHANGE</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c1"># Create the color palette</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">([</span><span class="n">palecolor1</span><span class="p">,</span><span class="n">palecolor2</span><span class="p">,</span><span class="n">color3</span><span class="p">,</span><span class="n">color4</span><span class="p">])</span>
<span class="n">palette2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">([</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span> <span class="n">palecolor1</span><span class="p">,</span> <span class="n">palecolor2</span><span class="p">,</span><span class="n">color5</span><span class="p">,</span><span class="n">color6</span> <span class="p">,</span><span class="n">color7</span><span class="p">])</span>

<span class="c1"># # Create the color palette</span>
<span class="c1"># palette = sns.color_palette([color1, color2,color3])</span>
<span class="n">new_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">([</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span> <span class="n">color3</span><span class="p">,</span> <span class="n">color4</span><span class="p">])</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">randrange</span>
<span class="n">pvalue</span><span class="o">=</span><span class="mf">0.05</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scanpy&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
Scanpy 1.10.3
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/adata_normalised_cellcycle.h5ad&quot;</span><span class="p">)</span>
<span class="c1">#set the directio</span>
<span class="c1">#perform log1p on the data</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment_simple&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;non&quot;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Non&quot;</span><span class="p">))),</span> <span class="s2">&quot;non-targeting&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment&quot;</span><span class="p">])</span>
<span class="n">gene_list_select</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment_simple&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment_simple&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="c1"># sc.tl.rank_genes_groups(adata, &#39;guide_assignment_simple&#39;, groups=gene_list_select,reference=&quot;non-targeting&quot;, method=&#39;wilcoxon&#39;, use_raw=False)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s1">&#39;guide_assignment_simple&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">gene_list_select</span><span class="p">,</span><span class="n">reference</span><span class="o">=</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;t-test&#39;</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
... storing &#39;guide_assignment_simple&#39; as categorical
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#get the differentially expressed genes</span>
<span class="c1"># %%capture</span>
<span class="n">gene_list</span><span class="o">=</span><span class="p">[]</span>
<span class="n">pvalue</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">number</span><span class="o">=</span><span class="mi">1000</span>
<span class="n">sortby</span><span class="o">=</span><span class="s2">&quot;pvals_adj_1&quot;</span>
<span class="n">min_fc</span><span class="o">=</span><span class="mf">0.5</span>
<span class="c1">#get the highly_variable genes</span>
<span class="n">extract_highly_variable_genes</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;highly_variable&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">gene_list_recursive</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="c1">#remove ARNT and if gene_A CSNK1E</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#get the differentially expressed genes</span>
<span class="c1"># %%capture</span>
<span class="n">gene_list</span><span class="o">=</span><span class="p">[]</span>
<span class="n">pvalue</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">logFC</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">number</span><span class="o">=</span><span class="mi">1000</span>
<span class="n">sortby</span><span class="o">=</span><span class="s2">&quot;rank_1&quot;</span>
<span class="n">min_fc</span><span class="o">=</span><span class="mi">1</span>
<span class="c1">#get the highly_variable genes</span>
<span class="n">extract_highly_variable_genes</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;highly_variable&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">gene_list_recursive</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="c1">#remove ARNT and if gene_A CSNK1E</span>
<span class="n">gene_list_recursive</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="o">~</span><span class="n">gene_list_recursive</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;ARNT&quot;</span><span class="p">,</span><span class="s2">&quot;CSNK1E&quot;</span><span class="p">])]</span>
<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;True&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="c1"># print(gene)</span>
    <span class="c1">#AP</span>
    <span class="n">gene_AP</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_AP&quot;</span>
    <span class="k">if</span> <span class="n">gene_AP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">gene</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ARNT&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ARNT&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">promoter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">,</span><span class="s2">&quot;AP&quot;</span><span class="p">]:</span>
            <span class="n">gene_promoter</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gene_promoter_2</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gene_promoter_random_1</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_list_recursive</span><span class="p">))]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gene_promoter_random_2</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_list_recursive</span><span class="p">))]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">##form a dataframe with custom colummns</span>
            <span class="c1">#subset random gene from gene list</span>
            <span class="n">protospacer_1</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="c1">#order by the absolute value of the logfoldchange</span>
            <span class="n">protospacer_1</span><span class="p">[</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">protospacer_1</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="n">protospacer_1</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#add a rank column</span>
            <span class="n">protospacer_1</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">protospacer_2</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter_2</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_2</span><span class="p">[</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">protospacer_2</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="n">protospacer_2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#add a rank column</span>
            <span class="n">protospacer_2</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">protospacer_1_random</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter_random_1</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_1_random</span><span class="p">[</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">protospacer_1_random</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="n">protospacer_1_random</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#add a rank column</span>
            <span class="n">protospacer_1_random</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_1_random</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">protospacer_2_random</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter_random_2</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_2_random</span><span class="p">[</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">protospacer_2_random</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
            <span class="n">protospacer_2_random</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;abs_logfoldchanges&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#add a rank column</span>
            <span class="n">protospacer_2_random</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_2_random</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">gene_df</span><span class="o">=</span><span class="n">protospacer_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">protospacer_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="c1">#filter for highly variable genes</span>
            <span class="n">gene_df_random_1</span><span class="o">=</span><span class="n">protospacer_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">protospacer_1_random</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">gene_df_random_2</span><span class="o">=</span><span class="n">protospacer_1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">protospacer_2_random</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">rank_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rank_1&quot;</span><span class="p">,</span><span class="s2">&quot;rank_2&quot;</span><span class="p">]</span>
            <span class="c1">#get the correlation for  scores_1 and scores_2 for corr</span>
            <span class="n">correlation_1</span><span class="o">=</span><span class="n">gene_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sortby</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">rank_columns</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;spearman&#39;</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">correlation_random_1</span><span class="o">=</span><span class="n">gene_df_random_1</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sortby</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">rank_columns</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;spearman&#39;</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">correlation_random_2</span><span class="o">=</span><span class="n">gene_df_random_2</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sortby</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">rank_columns</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;spearman&#39;</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#create a row wtht he gene name</span>
            <span class="n">gene_list_row</span><span class="o">=</span><span class="p">[</span><span class="n">gene</span><span class="p">,</span><span class="n">promoter</span><span class="p">]</span>
            <span class="n">gene_list_row</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">correlation_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;rank_1&quot;</span><span class="p">,</span><span class="s2">&quot;rank_2&quot;</span><span class="p">],</span><span class="n">correlation_random_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;rank_1&quot;</span><span class="p">,</span><span class="s2">&quot;rank_2&quot;</span><span class="p">],</span><span class="n">correlation_random_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;rank_1&quot;</span><span class="p">,</span><span class="s2">&quot;rank_2&quot;</span><span class="p">]])</span>
            <span class="n">gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene_list_row</span><span class="p">)</span>


<span class="c1">#flatten list of lists into dataframe</span>
<span class="n">gene_df_final</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gene_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;promoter&quot;</span><span class="p">,</span><span class="s2">&quot;scores_1_targeted&quot;</span><span class="p">,</span><span class="s2">&quot;scores_1_random&quot;</span><span class="p">,</span><span class="s2">&quot;scores_2_random&quot;</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#get the differentially expressed genes</span>
<span class="c1"># %%capture</span>
<span class="c1"># pvalue=0.05</span>
<span class="n">gene_list</span><span class="o">=</span><span class="p">[]</span>
<span class="n">gene_list_recursive</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="c1">#remove ARNT and if gene_A CSNK1E</span>
<span class="n">gene_list_recursive</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="o">~</span><span class="n">gene_list_recursive</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;ARNT&quot;</span><span class="p">,</span><span class="s2">&quot;CSNK1E&quot;</span><span class="p">])]</span>
<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;True&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
    <span class="c1">#AP</span>
    <span class="n">gene_AP</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_AP&quot;</span>
    <span class="k">if</span> <span class="n">gene_AP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">elif</span> <span class="n">gene</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ARNT&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ARNT&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">promoter</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">,</span><span class="s2">&quot;AP&quot;</span><span class="p">]:</span>
            <span class="n">gene_promoter</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">protospacer_1</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_1</span><span class="o">=</span><span class="n">protospacer_1</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">gene_promoter</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">protospacer_2</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_2</span><span class="o">=</span><span class="n">protospacer_2</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">gene_promoter</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_list_recursive</span><span class="p">))]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">protospacer_1_random</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_1_random</span><span class="o">=</span><span class="n">protospacer_1_random</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">gene_promoter</span><span class="o">=</span><span class="n">gene_list_recursive</span><span class="p">[</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_list_recursive</span><span class="p">))]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">promoter</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">protospacer_2_random</span><span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_promoter</span><span class="p">,</span><span class="n">pval_cutoff</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span>
            <span class="n">protospacer_2_random</span><span class="o">=</span><span class="n">protospacer_2_random</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>


            <span class="n">overlap</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protospacer_1</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protospacer_2</span><span class="p">]</span>
            <span class="n">overlap_random_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protospacer_1_random</span><span class="p">]</span>
            <span class="n">overlap_random_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">overlap</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">protospacer_2_random</span><span class="p">]</span>
            <span class="c1">#if overlap protospacer_1 protospacer_2 overlap_random_2 overlap_random_1 = 0 set to 1</span>
            <span class="c1"># print(protospacer_1,protospacer_2,overlap,overlap_random_1,overlap_random_2)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">overlap_1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_1</span><span class="p">)</span>
                <span class="n">overlap_2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_2</span><span class="p">)</span>
                <span class="n">overlap_random_1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap_random_1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_1_random</span><span class="p">)</span>
                <span class="n">overlap_random_2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap_random_2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">protospacer_2_random</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">overlap_1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">overlap_2</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">overlap_random_1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">overlap_random_2</span><span class="o">=</span><span class="mi">0</span>

            <span class="n">gene_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">gene</span><span class="p">,</span><span class="n">promoter</span><span class="p">,</span><span class="n">overlap_1</span><span class="p">,</span><span class="n">overlap_2</span><span class="p">,</span><span class="n">overlap_random_1</span><span class="p">,</span><span class="n">overlap_random_2</span><span class="p">]])</span>
            <span class="c1"># gene_df_details=pd.DataFrame([[gene,promoter,protospacer_1,protospacer_2,overlap,len(protospacer_1),len(protospacer_2),len(overlap)]])</span>

            <span class="c1"># print(gene_df.shape)</span>
            <span class="n">gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene_df</span><span class="p">)</span>
            <span class="c1"># break</span>


<span class="c1"># col_names=[&quot;Gene&quot;,&quot;Promoter&quot;,&quot;Protospacer_1&quot;,&quot;Protospacer_2&quot;,&quot;Overlap&quot;,&quot;Protospacer_Random_1&quot;,&quot;Protospacer_Random_2&quot;]</span>
<span class="c1">#add col_names</span>
<span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">,</span><span class="s2">&quot;Promoter&quot;</span><span class="p">,</span><span class="s2">&quot;Overlap_1&quot;</span><span class="p">,</span><span class="s2">&quot;Overlap_2&quot;</span><span class="p">,</span><span class="s2">&quot;Overlap_Random_1&quot;</span><span class="p">,</span><span class="s2">&quot;Overlap_Random_2&quot;</span><span class="p">]</span>
<span class="nb">all</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gene_list</span><span class="p">))</span>
<span class="nb">all</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">col_names</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AHCYL1
SP1
TGIF1
YWHAZ
P4HB
NCOR2
JARID2
ESR1
PA2G4
GPBP1
DHX30
SAFB
NFE2L2
CHD8
SIN3A
PSMC5
RC3H2
ZNF3
GTF2F1
ADAR
NR2F2
BZW1
FHL2
SET
MYBBP1A
CUX1
NBN
CALR
APP
STAG2
PKM
BRIP1
GATA3
RBM47
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#get the tests between two unpaired parametric groups</span>
<span class="c1">#melt for random</span>
<span class="n">all_melt</span><span class="o">=</span><span class="nb">all</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">,</span><span class="s2">&quot;Promoter&quot;</span><span class="p">])</span>
<span class="nb">all</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_1&quot;</span><span class="p">],</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_2&quot;</span><span class="p">],</span><span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_Random_1&quot;</span><span class="p">],</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_Random_2&quot;</span><span class="p">],</span><span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_1&quot;</span><span class="p">],</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_Random_1&quot;</span><span class="p">],</span><span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_2&quot;</span><span class="p">],</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_Random_2&quot;</span><span class="p">],</span><span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
TtestResult(statistic=-1.200758436011414, pvalue=0.23196364293947955, df=133.97197243239725)
TtestResult(statistic=-0.8170297166398177, pvalue=0.4153781706070453, df=132.49121568852897)
TtestResult(statistic=10.428675297500293, pvalue=2.596256035375967e-18, df=114.67625808804517)
TtestResult(statistic=10.723518386158062, pvalue=2.9404501919466304e-19, df=120.79414195321442)
</pre></div></div>
</div>
<p>A central goal of this notebook is to determine the degree of overlap between the pathways regulated by different promoters of the same gene.</p>
<p>Limited Overlap: The analysis reveals that for most genes, there is minimal overlap between the DEGs affected by P1 versus P2 knockdown. This supports the conclusion that alternative promoters regulate largely distinct downstream pathways.</p>
<p>Z-Score Correlation: For the small subset of shared DEGs, the notebook calculates Pearson correlations of Z-scores. As shown in the study, these shared genes typically show high positive correlations, indicating a coherent regulatory response even when the number of shared genes is small.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot the overlap between the two guides</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;talk&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">#show the percentage over &quot;Overlap_length&quot;/&quot;Protospacer_1_length&quot;</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_melt</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="n">hue</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">new_pallete</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">#save plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/overlap_gene_signature.pdf&quot;</span><span class="p">)</span>
<span class="n">gene_list_select</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s1">&#39;guide_id&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">gene_list_select</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span><span class="n">reference</span><span class="o">=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;t-test&#39;</span><span class="p">)</span>
<span class="n">genelist</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;guide_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># comp_gene_list MP vs AP summary table for each candidate gene</span>
<span class="c1"># all_genes_df full DE results for all guides (MP and AP)</span>
<span class="c1"># all_genes_df_filt statistically significant DEGs used for downstream signature analysis</span>

<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s1">&#39;guide_id&#39;</span><span class="p">,</span><span class="n">groups</span><span class="o">=</span><span class="n">genelist</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1">#get target gene logfoldchanges</span>
<span class="c1">#get the differentially expressed genes</span>
<span class="n">gene_list</span><span class="o">=</span><span class="p">[]</span>
<span class="n">comp_gene_list</span><span class="o">=</span><span class="p">[]</span>

<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;True&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="c1"># print(gene)</span>
    <span class="c1">#AP</span>
    <span class="n">gene_AP</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_AP&quot;</span>
    <span class="n">gene_MP</span><span class="o">=</span><span class="n">gene</span><span class="o">+</span><span class="s2">&quot;_MP&quot;</span>

    <span class="k">if</span> <span class="n">gene_AP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">][(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;True&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">##form a dataframe with custom colummns</span>
        <span class="n">MP</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_MP</span><span class="p">)</span>
        <span class="n">MP_filt</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[(</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">gene</span><span class="p">)]</span>
        <span class="n">AP</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_AP</span><span class="p">)</span>
        <span class="n">AP_filt</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[(</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">gene</span><span class="p">)]</span>
        <span class="c1">#do it for every gene</span>
        <span class="n">MP</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">gene_MP</span>
        <span class="n">AP</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">gene_AP</span>
        <span class="n">gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MP</span><span class="p">)</span>
        <span class="n">gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AP</span><span class="p">)</span>
        <span class="n">promoter_line</span><span class="o">=</span><span class="p">[</span><span class="n">gene</span><span class="p">,</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;pvals_adj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;pvals_adj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">comp_gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">promoter_line</span><span class="p">)</span>
<span class="c1">#convert to dataframe</span>
<span class="n">comp_gene_list</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comp_gene_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;MP_zscore&quot;</span><span class="p">,</span><span class="s2">&quot;MP_logfoldchange&quot;</span><span class="p">,</span><span class="s2">&quot;MP_pvalue&quot;</span><span class="p">,</span><span class="s2">&quot;AP_zscore&quot;</span><span class="p">,</span><span class="s2">&quot;AP_logfoldchange&quot;</span><span class="p">,</span><span class="s2">&quot;AP_pvalue&quot;</span><span class="p">])</span>

<span class="c1">#merge all gene dfs</span>
<span class="n">all_genes_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gene_list</span><span class="p">))</span>
<span class="c1">#change the column names</span>
<span class="n">all_genes_df</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">,</span><span class="s2">&quot;pvals&quot;</span><span class="p">,</span><span class="s2">&quot;pvals_adj&quot;</span><span class="p">,</span><span class="s2">&quot;pct_nz_group&quot;</span><span class="p">,</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span>
<span class="c1">#filter for logfoldchange &gt; 0.5 and pvalue &lt; 0.05</span>
<span class="n">all_genes_df_filt</span><span class="o">=</span><span class="n">all_genes_df</span><span class="p">[(</span><span class="n">all_genes_df</span><span class="p">[</span><span class="s2">&quot;pvals_adj&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_genes_df</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">)]</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># Run DE once</span>
<span class="c1"># all  ‚Üí Summary of MP/AP DEG counts &amp; correlations (one row per target gene)</span>
<span class="c1"># directional_genes_df ‚Üí Up- and down-regulated DEG signatures per target</span>
<span class="c1"># all_filt ‚Üí Summary table filtered for successful KD</span>

<span class="n">gene_list</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># per-target summary (MP/AP counts, overlap, correlation)</span>
<span class="n">comp_gene_list</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># full DE tables for each MP/AP guide</span>
<span class="n">directional_genes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># per-target, per-direction summary (Up / Down)</span>

<span class="c1"># Cache valid guides to avoid recomputing each loop</span>
<span class="n">valid_guides</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="s2">&quot;guide_id&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">perturbations</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="s2">&quot;perturbation&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">perturbations</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>

    <span class="n">gene_AP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_AP&quot;</span>
    <span class="n">gene_MP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_MP&quot;</span>

    <span class="c1"># skip if there is no AP guide for this gene</span>
    <span class="k">if</span> <span class="n">gene_AP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_guides</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># ------- MP -------</span>
    <span class="n">MP</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_MP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">MP</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">MP_names</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">MP_up</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">MP_up_names</span> <span class="o">=</span> <span class="n">MP_up</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">MP_down</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">MP_down_names</span> <span class="o">=</span> <span class="n">MP_down</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ------- AP -------</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_AP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">AP</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">AP_names</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">AP_up</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">AP_up_names</span> <span class="o">=</span> <span class="n">AP_up</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">AP_down</span> <span class="o">=</span> <span class="n">AP</span><span class="p">[</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">AP_down_names</span> <span class="o">=</span> <span class="n">AP_down</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># ------- Overlaps -------</span>
    <span class="n">overlap</span>       <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">MP_names</span>      <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">AP_names</span><span class="p">]</span>
    <span class="n">overlap_up</span>    <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">MP_up_names</span>   <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">AP_up_names</span><span class="p">]</span>
    <span class="n">overlap_down</span>  <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">MP_down_names</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">AP_down_names</span><span class="p">]</span>

    <span class="c1"># correlation of scores for overlapping genes (MP vs AP)</span>
    <span class="n">correlation_value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">corr_df</span> <span class="o">=</span> <span class="n">MP</span><span class="p">[</span><span class="n">MP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">overlap</span><span class="p">)]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">AP</span><span class="p">[</span><span class="n">AP</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">overlap</span><span class="p">)],</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_MP&quot;</span><span class="p">,</span> <span class="s2">&quot;_AP&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">corr_df</span><span class="p">[[</span><span class="s2">&quot;scores_MP&quot;</span><span class="p">,</span> <span class="s2">&quot;scores_AP&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">correlation_value</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;scores_MP&quot;</span><span class="p">,</span> <span class="s2">&quot;scores_AP&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">correlation_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="c1"># ------- per-gene summary row -------</span>
    <span class="n">gene_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">[[</span>
            <span class="n">gene</span><span class="p">,</span>
            <span class="n">MP_names</span><span class="p">,</span>
            <span class="n">AP_names</span><span class="p">,</span>
            <span class="n">overlap</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">MP_names</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">AP_names</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">),</span>
            <span class="n">correlation_value</span>
        <span class="p">]]</span>
    <span class="p">)</span>
    <span class="n">gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene_row</span><span class="p">)</span>

    <span class="c1"># ------- directional (Up / Down) rows -------</span>
    <span class="n">gene_direction_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">gene</span><span class="p">,</span>
                <span class="n">MP_up_names</span><span class="p">,</span>
                <span class="n">AP_up_names</span><span class="p">,</span>
                <span class="n">overlap_up</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">MP_up_names</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">AP_up_names</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">overlap_up</span><span class="p">),</span>
                <span class="s2">&quot;Up&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="n">gene</span><span class="p">,</span>
                <span class="n">MP_down_names</span><span class="p">,</span>
                <span class="n">AP_down_names</span><span class="p">,</span>
                <span class="n">overlap_down</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">MP_down_names</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">AP_down_names</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">overlap_down</span><span class="p">),</span>
                <span class="s2">&quot;Down&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">directional_genes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gene_direction_df</span><span class="p">)</span>

    <span class="c1"># ------- full DE tables with guide labels -------</span>
    <span class="n">MP</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_MP</span>
    <span class="n">AP</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_AP</span>
    <span class="n">comp_gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MP</span><span class="p">)</span>
    <span class="n">comp_gene_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AP</span><span class="p">)</span>

<span class="c1"># ---------- build final dataframes ----------</span>

<span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MP_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AP_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Overlap_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;correlation_value&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="nb">all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gene_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="nb">all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_names</span>

<span class="c1"># only directional</span>
<span class="n">directional_genes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">directional_genes</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">directional_genes_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MP_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AP_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Overlap_Genes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Direction&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># filter to successful KDs</span>
<span class="n">successful</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="s2">&quot;gene&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">directional_genes_df</span> <span class="o">=</span> <span class="n">directional_genes_df</span><span class="p">[</span>
    <span class="n">directional_genes_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">successful</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">all_filt</span> <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">successful</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># save if you want</span>
<span class="c1"># all_filt.to_csv(loc+&quot;files/singlecell_shortread_analysis/differential_exp_list.csv&quot;)</span>
<span class="n">all_filt</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_list_corr.csv&quot;</span><span class="p">)</span>
<span class="n">comp_gene_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">comp_gene_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">comp_gene_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_fulltable.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">directional_genes_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_directional_genes.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot all_filt</span>
<span class="c1">#plot the correlation_value</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">all_filt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;correlation_value&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Correlation between Z-Scores </span><span class="se">\n</span><span class="s2"> from Overlapping DEGs in P1 and P2 &quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count of Target Genes&quot;</span><span class="p">)</span>
<span class="c1">#add the number of genes with a value not na and all the genes</span>
<span class="n">num_genes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_filt</span><span class="p">)</span>
<span class="n">signif_genes</span><span class="o">=</span><span class="n">all_filt</span><span class="p">[</span><span class="n">all_filt</span><span class="p">[</span><span class="s2">&quot;correlation_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
<span class="n">num_signif_genes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">signif_genes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Significant n=</span><span class="si">{</span><span class="n">num_signif_genes</span><span class="si">}</span><span class="s1"> / Total n=</span><span class="si">{</span><span class="n">num_genes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="c1"># all_filt</span>
<span class="c1">#save</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/correlation_DEG_Zscores_MP_AP.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_13_0.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_13_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#save directional_genes_df to csv</span>
<span class="n">directional_genes_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_directional_genes.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># long format for plotting distributions</span>
<span class="n">long</span> <span class="o">=</span> <span class="n">directional_genes_df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span> <span class="s2">&quot;Direction&quot;</span><span class="p">],</span>
    <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">,</span> <span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">,</span> <span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">],</span>
    <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;N_genes&quot;</span>
<span class="p">)</span>

<span class="c1"># optional: nicer labels</span>
<span class="n">long</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">long</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
    <span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">:</span> <span class="s2">&quot;P1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">:</span> <span class="s2">&quot;P2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">:</span> <span class="s2">&quot;Overlap&quot;</span>
<span class="p">})</span>

<span class="c1"># Add log10 transform column</span>
<span class="n">long</span><span class="p">[</span><span class="s2">&quot;log10_N_genes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;N_genes&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-7</span><span class="p">)</span>  <span class="c1"># replaces 0 by 1</span>
<span class="c1">#add log appropriate long[&quot;N_genes&quot;] by assigning it as +0.0000001</span>
<span class="c1">#drop duplicates</span>
<span class="n">long</span><span class="p">[</span><span class="s2">&quot;N_adj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">long</span><span class="p">[</span><span class="s2">&quot;N_genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="n">long</span> <span class="o">=</span> <span class="n">long</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#make the background axes lines</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

<span class="c1"># ---- UP ----</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">long</span><span class="p">[</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Up&quot;</span><span class="p">],</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;N_adj&quot;</span><span class="p">,</span>
    <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">long</span><span class="p">[</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Up&quot;</span><span class="p">],</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;N_adj&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Up-regulated DEGs (log10)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# DE genes per target&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="c1"># ---- DOWN ----</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">long</span><span class="p">[</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Down&quot;</span><span class="p">],</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;N_adj&quot;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Set2&quot;</span><span class="p">,</span>
    <span class="n">showfliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">long</span><span class="p">[</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Down&quot;</span><span class="p">],</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Category&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;N_adj&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Down-regulated DEGs (log10)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;# DE genes per target&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Category&quot;</span><span class="p">)</span>
<span class="c1">#change 10-1 to 0 on y axis</span>
<span class="n">tick_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">tick_vals</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;100&quot;</span><span class="p">])</span>

<span class="c1">#repeat for both axes</span>

<span class="c1">#save as pdf</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/DEG_counts_per_target_promoter.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/r_/bqnt2f_d6919cz7v1yzx2ykc0000gn/T/ipykernel_22880/435962864.py:29: FutureWarning:

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.boxplot(
/var/folders/r_/bqnt2f_d6919cz7v1yzx2ykc0000gn/T/ipykernel_22880/435962864.py:52: FutureWarning:

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.boxplot(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_15_1.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_15_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#find the top overlapping genes</span>
<span class="n">long</span><span class="p">[(</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">long</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;Overlap&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;N_genes&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Target_Gene</th>
      <th>Direction</th>
      <th>Category</th>
      <th>N_genes</th>
      <th>log10_N_genes</th>
      <th>N_adj</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>185</th>
      <td>MYBBP1A</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>33</td>
      <td>1.5185</td>
      <td>33.0000</td>
    </tr>
    <tr>
      <th>151</th>
      <td>ESR1</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>21</td>
      <td>1.3222</td>
      <td>21.0000</td>
    </tr>
    <tr>
      <th>201</th>
      <td>GATA3</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>20</td>
      <td>1.3010</td>
      <td>20.0000</td>
    </tr>
    <tr>
      <th>203</th>
      <td>RBM47</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>18</td>
      <td>1.2553</td>
      <td>18.0000</td>
    </tr>
    <tr>
      <th>169</th>
      <td>RC3H2</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>18</td>
      <td>1.2553</td>
      <td>18.0000</td>
    </tr>
    <tr>
      <th>149</th>
      <td>JARID2</td>
      <td>Down</td>
      <td>Overlap</td>
      <td>17</td>
      <td>1.2304</td>
      <td>17.0000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#can check that there are no genes with logfoldchange between -0.5 and 0.5 ad that pvals_adj</span>
<span class="nb">print</span><span class="p">(</span><span class="n">all_genes_df_filt</span><span class="p">[(</span><span class="n">all_genes_df_filt</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">&lt;=</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_genes_df_filt</span><span class="p">[</span><span class="s2">&quot;pvals_adj&quot;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">)]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">#chec number of genes with sig. DEG all_genes_df_filt ESR1_MP ESR1_AP</span>
<span class="c1">#plot the distribution of logfoldchanges for ESR1_MP and ESR1_AP</span>
<span class="n">all_genes_df_esr1</span><span class="o">=</span><span class="n">all_genes_df_filt</span><span class="p">[</span><span class="n">all_genes_df_filt</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;ESR1_MP&quot;</span><span class="p">,</span><span class="s2">&quot;ESR1_AP&quot;</span><span class="p">])]</span>
<span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span><span class="s2">&quot;Down&quot;</span><span class="p">)</span>
<span class="c1">#check the number of MP and AP genes per target gene and their overlap using</span>
<span class="n">number_of_genes</span><span class="o">=</span><span class="n">all_genes_df_esr1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">,</span><span class="s2">&quot;Direction&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#see the number of gene that overlap between MP and AP</span>
<span class="n">overlap_genes</span><span class="o">=</span><span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;ESR1_MP&quot;</span><span class="p">][</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="n">all_genes_df_esr1</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;ESR1_AP&quot;</span><span class="p">][</span><span class="s2">&quot;gene&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">number_of_genes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of overlapping genes between ESR1_MP and ESR1_AP:&quot;</span><span class="p">,</span> <span class="n">overlap_genes</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0, 7)
Direction      Down   Up
targeted_gene
ESR1_AP         634  355
ESR1_MP         154    0
Number of overlapping genes between ESR1_MP and ESR1_AP: 21
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/r_/bqnt2f_d6919cz7v1yzx2ykc0000gn/T/ipykernel_22880/1044356788.py:7: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  all_genes_df_esr1[&#34;Direction&#34;]=np.where(all_genes_df_esr1[&#34;logfoldchanges&#34;]&gt;0, &#34;Up&#34;,&#34;Down&#34;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><span></span><span class="n">genes_of_interest</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;JARID2&quot;</span><span class="p">,</span> <span class="s2">&quot;RC3H2&quot;</span><span class="p">,</span> <span class="s2">&quot;RBM47&quot;</span><span class="p">,</span><span class="s2">&quot;GATA3&quot;</span><span class="p">,</span> <span class="s2">&quot;ESR1&quot;</span><span class="p">,</span> <span class="s2">&quot;MYBBP1A&quot;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="c1"># Determine grid shape</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes_of_interest</span><span class="p">)</span>
<span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">))</span>



<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">3</span> <span class="p">),</span>
        <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span>   <span class="c1"># &lt;-- keep y shared, but NOT x</span>
    <span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1">#sub genes_of_interest list for current row</span>
    <span class="n">row_genes_of_interest</span> <span class="o">=</span> <span class="n">genes_of_interest</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">ncols</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ncols</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">tg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">row_genes_of_interest</span><span class="p">):</span>

        <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">all_genes_df_filt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">all_genes_df_filt</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tg</span><span class="si">}</span><span class="s2">_MP&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;scores&quot;</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="s2">&quot;score_MP&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">ap</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">all_genes_df_filt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">all_genes_df_filt</span><span class="p">[</span><span class="s2">&quot;targeted_gene&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tg</span><span class="si">}</span><span class="s2">_AP&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;scores&quot;</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="s2">&quot;score_AP&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="n">overlap</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overlap</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tg</span><span class="si">}</span><span class="s2">: no overlapping genes&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s2">&quot;score_MP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">overlap</span><span class="p">[</span><span class="s2">&quot;score_AP&quot;</span><span class="p">])</span>

        <span class="c1"># draw heatmap</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">overlap</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;gene&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;vlag&quot;</span><span class="p">,</span>
            <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Z-Score&quot;</span><span class="p">},</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="p">)</span>

        <span class="c1"># ---- force ALL gene labels to show ----</span>
        <span class="n">genes</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>        <span class="c1"># centers of cells</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">genes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">#remove yticklabels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tg</span><span class="si">}</span><span class="se">\n</span><span class="s2">n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap</span><span class="p">)</span><span class="si">}</span><span class="s2">, r=</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="c1">#save</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;figures/DEG_Zscore_heatmap_MP_AP_row</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 640x480 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_1.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_2.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_2.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_3.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_18_3.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#change MP to P1 and AP to P2</span>
<span class="n">comp_gene_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_gene_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_MP&quot;</span><span class="p">,</span> <span class="s2">&quot;_P1&quot;</span><span class="p">)</span>
<span class="n">comp_gene_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_gene_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_AP&quot;</span><span class="p">,</span> <span class="s2">&quot;_P2&quot;</span><span class="p">)</span>
<span class="n">pivot_df</span> <span class="o">=</span> <span class="n">comp_gene_df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;names&quot;</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;Guide&quot;</span><span class="p">,</span>
    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;logfoldchanges&quot;</span><span class="p">,</span>
    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;median&quot;</span>
<span class="p">)</span>

<span class="n">pivot_df</span> <span class="o">=</span> <span class="n">pivot_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="c1">#make figure larger</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">#make max and min +2 and -2</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">pivot_df</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># set to True if you want labels (but 17k genes = unreadable)</span>
    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;LogFC Heatmap for all guides&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Guide&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Genes&quot;</span><span class="p">)</span>
<span class="c1">#remove vadj</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1">#make x smaller size</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="c1">#add colorbar label titlee saying Log Fold Change</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Log Fold Change (Capped ¬±2)&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_19_0.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_19_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#make a correlation between the logfoldchanges for MP vs AP for all genes</span>
<span class="n">corr</span><span class="o">=</span><span class="n">pivot_df</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;pearson&#39;</span><span class="p">,</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#plot the correlation as a heatmap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">corr</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span>

<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation Heatmap of LogFC between Guides&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Guide&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Guide&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([  0.5,   1.5,   2.5,   3.5,   4.5,   5.5,   6.5,   7.5,   8.5,
          9.5,  10.5,  11.5,  12.5,  13.5,  14.5,  15.5,  16.5,  17.5,
         18.5,  19.5,  20.5,  21.5,  22.5,  23.5,  24.5,  25.5,  26.5,
         27.5,  28.5,  29.5,  30.5,  31.5,  32.5,  33.5,  34.5,  35.5,
         36.5,  37.5,  38.5,  39.5,  40.5,  41.5,  42.5,  43.5,  44.5,
         45.5,  46.5,  47.5,  48.5,  49.5,  50.5,  51.5,  52.5,  53.5,
         54.5,  55.5,  56.5,  57.5,  58.5,  59.5,  60.5,  61.5,  62.5,
         63.5,  64.5,  65.5,  66.5,  67.5,  68.5,  69.5,  70.5,  71.5,
         72.5,  73.5,  74.5,  75.5,  76.5,  77.5,  78.5,  79.5,  80.5,
         81.5,  82.5,  83.5,  84.5,  85.5,  86.5,  87.5,  88.5,  89.5,
         90.5,  91.5,  92.5,  93.5,  94.5,  95.5,  96.5,  97.5,  98.5,
         99.5, 100.5, 101.5, 102.5, 103.5, 104.5, 105.5]),
 [Text(0, 0.5, &#39;ADAR_P1&#39;),
  Text(0, 1.5, &#39;ADAR_P2&#39;),
  Text(0, 2.5, &#39;AHCYL1_P1&#39;),
  Text(0, 3.5, &#39;AHCYL1_P2&#39;),
  Text(0, 4.5, &#39;APP_P1&#39;),
  Text(0, 5.5, &#39;APP_P2&#39;),
  Text(0, 6.5, &#39;ARNT_P1&#39;),
  Text(0, 7.5, &#39;ARNT_P2&#39;),
  Text(0, 8.5, &#39;BRIP1_P1&#39;),
  Text(0, 9.5, &#39;BRIP1_P2&#39;),
  Text(0, 10.5, &#39;BZW1_P1&#39;),
  Text(0, 11.5, &#39;BZW1_P2&#39;),
  Text(0, 12.5, &#39;CALR_P1&#39;),
  Text(0, 13.5, &#39;CALR_P2&#39;),
  Text(0, 14.5, &#39;CCND1_P1&#39;),
  Text(0, 15.5, &#39;CCND1_P2&#39;),
  Text(0, 16.5, &#39;CHD4_P1&#39;),
  Text(0, 17.5, &#39;CHD4_P2&#39;),
  Text(0, 18.5, &#39;CHD8_P1&#39;),
  Text(0, 19.5, &#39;CHD8_P2&#39;),
  Text(0, 20.5, &#39;CTNNB1_P1&#39;),
  Text(0, 21.5, &#39;CTNNB1_P2&#39;),
  Text(0, 22.5, &#39;CUX1_P1&#39;),
  Text(0, 23.5, &#39;CUX1_P2&#39;),
  Text(0, 24.5, &#39;DHX30_P1&#39;),
  Text(0, 25.5, &#39;DHX30_P2&#39;),
  Text(0, 26.5, &#39;EEF2_P1&#39;),
  Text(0, 27.5, &#39;EEF2_P2&#39;),
  Text(0, 28.5, &#39;ESR1_P1&#39;),
  Text(0, 29.5, &#39;ESR1_P2&#39;),
  Text(0, 30.5, &#39;FHL2_P1&#39;),
  Text(0, 31.5, &#39;FHL2_P2&#39;),
  Text(0, 32.5, &#39;GATA3_P1&#39;),
  Text(0, 33.5, &#39;GATA3_P2&#39;),
  Text(0, 34.5, &#39;GPBP1_P1&#39;),
  Text(0, 35.5, &#39;GPBP1_P2&#39;),
  Text(0, 36.5, &#39;GTF2F1_P1&#39;),
  Text(0, 37.5, &#39;GTF2F1_P2&#39;),
  Text(0, 38.5, &#39;HNRNPU_P1&#39;),
  Text(0, 39.5, &#39;HNRNPU_P2&#39;),
  Text(0, 40.5, &#39;JARID2_P1&#39;),
  Text(0, 41.5, &#39;JARID2_P2&#39;),
  Text(0, 42.5, &#39;KDM2A_P1&#39;),
  Text(0, 43.5, &#39;KDM2A_P2&#39;),
  Text(0, 44.5, &#39;MYBBP1A_P1&#39;),
  Text(0, 45.5, &#39;MYBBP1A_P2&#39;),
  Text(0, 46.5, &#39;NAP1L1_P1&#39;),
  Text(0, 47.5, &#39;NAP1L1_P2&#39;),
  Text(0, 48.5, &#39;NBN_P1&#39;),
  Text(0, 49.5, &#39;NBN_P2&#39;),
  Text(0, 50.5, &#39;NCOR2_P1&#39;),
  Text(0, 51.5, &#39;NCOR2_P2&#39;),
  Text(0, 52.5, &#39;NFE2L2_P1&#39;),
  Text(0, 53.5, &#39;NFE2L2_P2&#39;),
  Text(0, 54.5, &#39;NME2_P1&#39;),
  Text(0, 55.5, &#39;NME2_P2&#39;),
  Text(0, 56.5, &#39;NR2F2_P1&#39;),
  Text(0, 57.5, &#39;NR2F2_P2&#39;),
  Text(0, 58.5, &#39;P4HB_P1&#39;),
  Text(0, 59.5, &#39;P4HB_P2&#39;),
  Text(0, 60.5, &#39;PA2G4_P1&#39;),
  Text(0, 61.5, &#39;PA2G4_P2&#39;),
  Text(0, 62.5, &#39;PKM_P1&#39;),
  Text(0, 63.5, &#39;PKM_P2&#39;),
  Text(0, 64.5, &#39;PRRC2C_P1&#39;),
  Text(0, 65.5, &#39;PRRC2C_P2&#39;),
  Text(0, 66.5, &#39;PSMC5_P1&#39;),
  Text(0, 67.5, &#39;PSMC5_P2&#39;),
  Text(0, 68.5, &#39;RBM47_P1&#39;),
  Text(0, 69.5, &#39;RBM47_P2&#39;),
  Text(0, 70.5, &#39;RC3H2_P1&#39;),
  Text(0, 71.5, &#39;RC3H2_P2&#39;),
  Text(0, 72.5, &#39;SAFB_P1&#39;),
  Text(0, 73.5, &#39;SAFB_P2&#39;),
  Text(0, 74.5, &#39;SET_P1&#39;),
  Text(0, 75.5, &#39;SET_P2&#39;),
  Text(0, 76.5, &#39;SIN3A_P1&#39;),
  Text(0, 77.5, &#39;SIN3A_P2&#39;),
  Text(0, 78.5, &#39;SLTM_P1&#39;),
  Text(0, 79.5, &#39;SLTM_P2&#39;),
  Text(0, 80.5, &#39;SMARCA4_P1&#39;),
  Text(0, 81.5, &#39;SMARCA4_P2&#39;),
  Text(0, 82.5, &#39;SP1_P1&#39;),
  Text(0, 83.5, &#39;SP1_P2&#39;),
  Text(0, 84.5, &#39;SRSF5_P1&#39;),
  Text(0, 85.5, &#39;SRSF5_P2&#39;),
  Text(0, 86.5, &#39;STAG2_P1&#39;),
  Text(0, 87.5, &#39;STAG2_P2&#39;),
  Text(0, 88.5, &#39;STAT3_P1&#39;),
  Text(0, 89.5, &#39;STAT3_P2&#39;),
  Text(0, 90.5, &#39;STAU2_P1&#39;),
  Text(0, 91.5, &#39;STAU2_P2&#39;),
  Text(0, 92.5, &#39;TGIF1_P1&#39;),
  Text(0, 93.5, &#39;TGIF1_P2&#39;),
  Text(0, 94.5, &#39;TPD52L1_P1&#39;),
  Text(0, 95.5, &#39;TPD52L1_P2&#39;),
  Text(0, 96.5, &#39;UPF3B_P1&#39;),
  Text(0, 97.5, &#39;UPF3B_P2&#39;),
  Text(0, 98.5, &#39;XRCC5_P1&#39;),
  Text(0, 99.5, &#39;XRCC5_P2&#39;),
  Text(0, 100.5, &#39;YWHAZ_P1&#39;),
  Text(0, 101.5, &#39;YWHAZ_P2&#39;),
  Text(0, 102.5, &#39;ZNF217_P1&#39;),
  Text(0, 103.5, &#39;ZNF217_P2&#39;),
  Text(0, 104.5, &#39;ZNF3_P1&#39;),
  Text(0, 105.5, &#39;ZNF3_P2&#39;)])
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_20_1.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_20_1.png" />
</div>
</div>
<p>Pathway and GO Enrichment Analysis To move from individual gene lists to biological functions, the notebook conducts pathway enrichment analysis.</p>
<p>GSEA and pyGSEA: It performs pre-ranked Gene Set Enrichment Analysis (GSEA) using the <a class="reference external" href="GO:BP">GO:BP</a> (Gene Ontology: Biological Process) database.</p>
<p>NES Differences: The code quantifies differences between P1 and P2 at the pathway level by calculating the difference in Normalized Enrichment Scores (NES)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># list to collect per-guide GSEA results</span>
<span class="n">gsea_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># cache valid guides to avoid recomputing</span>
<span class="n">valid_guides</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="s2">&quot;guide_id&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># list of perturbed genes</span>
<span class="n">perturbations</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;non-targeting_Control&quot;</span><span class="p">,</span> <span class="s2">&quot;perturbation&quot;</span>
<span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">perturbations</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>

    <span class="n">gene_AP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_AP&quot;</span>
    <span class="n">gene_MP</span> <span class="o">=</span> <span class="n">gene</span> <span class="o">+</span> <span class="s2">&quot;_MP&quot;</span>

    <span class="c1"># skip if no AP guide for this gene</span>
    <span class="k">if</span> <span class="n">gene_AP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_guides</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># ---------- MP GUIDE ----------</span>
    <span class="c1"># get full DE table (NO pval/logFC cutoff for GSEA)</span>
    <span class="n">MP_rank</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_MP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># make a 2-column ranking like your STIM example:</span>
    <span class="c1">#   [names, logfoldchanges]</span>
    <span class="n">mp_rnk</span> <span class="o">=</span> <span class="n">MP_rank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="c1"># run prerank</span>
    <span class="n">pre_res_mp</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">prerank</span><span class="p">(</span>
        <span class="n">rnk</span><span class="o">=</span><span class="n">mp_rnk</span><span class="p">,</span>                 <span class="c1"># DataFrame with [gene, score]</span>
        <span class="n">gene_sets</span><span class="o">=</span><span class="s2">&quot;GO_Biological_Process_2021&quot;</span><span class="p">,</span>      <span class="c1"># or your favourite collection</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                <span class="c1"># don&#39;t write files</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">123</span>
    <span class="p">)</span>

    <span class="c1"># grab the result table</span>
    <span class="n">mp_res_df</span> <span class="o">=</span> <span class="n">pre_res_mp</span><span class="o">.</span><span class="n">res2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_MP</span>
    <span class="c1"># classify direction by NES sign</span>
    <span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mp_res_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span>
    <span class="n">gsea_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp_res_df</span><span class="p">)</span>

    <span class="c1"># ---------- AP GUIDE ----------</span>
    <span class="n">AP_rank</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">rank_genes_groups_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">gene_AP</span><span class="p">,</span> <span class="n">pval_cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">ap_rnk</span> <span class="o">=</span> <span class="n">AP_rank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">,</span> <span class="s2">&quot;logfoldchanges&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="n">pre_res_ap</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">prerank</span><span class="p">(</span>
        <span class="n">rnk</span><span class="o">=</span><span class="n">ap_rnk</span><span class="p">,</span>
        <span class="n">gene_sets</span><span class="o">=</span><span class="s2">&quot;GO_Biological_Process_2021&quot;</span><span class="p">,</span>
        <span class="n">outdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">123</span>
    <span class="p">)</span>

    <span class="n">ap_res_df</span> <span class="o">=</span> <span class="n">pre_res_ap</span><span class="o">.</span><span class="n">res2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_AP</span>
    <span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ap_res_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span>
    <span class="n">gsea_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ap_res_df</span><span class="p">)</span>

<span class="n">gsea_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gsea_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">gsea_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gsea_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">gsea_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">successful_guides</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">][</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;True&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#filter for only genes in the whippet siuccessful KD</span>
<span class="n">gsea_results_df</span> <span class="o">=</span> <span class="n">gsea_results_df</span><span class="p">[</span><span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">successful_guides</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Clean up pathway names a bit (optional)</span>
<span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;Pathway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;Term&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot; Homo sapiens.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;P1&quot;</span> <span class="k">if</span> <span class="s2">&quot;_MP&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="s2">&quot;P2&quot;</span><span class="p">)</span>

<span class="c1"># Filter to significant pathways</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">gsea_results_df</span><span class="p">[(</span><span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;NOM p-val&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gsea_results_df</span><span class="p">[</span><span class="s2">&quot;FDR q-val&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Keep only pathways that appear in ‚â•2 target genes (shared)</span>
<span class="n">pathway_counts</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Pathway&quot;</span><span class="p">)[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">shared_pathways</span> <span class="o">=</span> <span class="n">pathway_counts</span><span class="p">[</span><span class="n">pathway_counts</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">sig_shared</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="n">sig</span><span class="p">[</span><span class="s2">&quot;Pathway&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shared_pathways</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># This is your ‚Äúsignificant shared list‚Äù</span>
<span class="n">sig_shared</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;significant_shared_pathways.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sig_shared</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="c1">#save sig</span>
<span class="n">sig</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/significant_genes.xlsx&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
          Name                                               Term      ES  \
4075   prerank  positive regulation of potassium ion transport...  0.7394
8155   prerank  positive regulation of cellular component move... -0.9718
8160   prerank  negative regulation of endopeptidase activity ... -0.9330
10185  prerank  positive regulation of biosynthetic process (G...  0.7262
16299  prerank  positive regulation of phospholipase activity ... -0.9546

          NES NOM p-val FDR q-val FWER p-val Tag % Gene %  \
4075   1.8924    0.0025    0.2356     0.2740  4/16  5.02%
8155  -1.6374    0.0000    0.0601     0.0600  3/15  0.59%
8160  -1.6019    0.0064    0.1928     0.4290  5/20  2.34%
10185  1.9967    0.0000    0.0651     0.0590  5/25  3.00%
16299 -1.6885    0.0050    0.1416     0.1250  3/15  1.78%

                                   Lead_genes Target_Gene     Guide Direction  \
4075              GABBR2;ADRA2A;KCNMB4;KCNMB3         SP1    SP1_MP        Up
8155                          TWIST1;CCR7;LYN       TGIF1  TGIF1_MP      Down
8160   SERPINB8;RECK;SERPINI1;SPINK2;SERPINE2       TGIF1  TGIF1_MP      Down
10185        MLXIPL;CREB3L1;SORBS1;SIRT4;WNT4       TGIF1  TGIF1_AP        Up
16299                        FLT1;NTRK3;AGTR1        P4HB   P4HB_MP      Down

                                                 Pathway Condition
4075   positive regulation of potassium ion transport...        P1
8155   positive regulation of cellular component move...        P1
8160   negative regulation of endopeptidase activity ...        P1
10185  positive regulation of biosynthetic process (G...        P2
16299  positive regulation of phospholipase activity ...        P1
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#use pathway_counts to count the number of pathways with the number fo genes</span>
<span class="n">pathway_counts_count</span> <span class="o">=</span> <span class="n">pathway_counts</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">pathway_counts_count</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">pathway_counts_count</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number of Gene Ontology Biological Process Pathways&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Pseudobulk Perturbations per Pathway&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
/var/folders/r_/bqnt2f_d6919cz7v1yzx2ykc0000gn/T/ipykernel_22880/1666908462.py:5: FutureWarning:

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.barplot(y=pathway_counts_count.values, x=pathway_counts_count.index, palette=&#34;viridis&#34;)
INFO:matplotlib.category:Using categorical units to plot a list of strings that are all parsable as floats or dates. If these strings should be plotted as numbers, cast to the appropriate data type before plotting.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_25_1.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_25_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#find the average difference NES between P1 and P2 for each gene</span>
<span class="n">nes_diff_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">sig</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">gene_df</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="n">sig</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gene</span><span class="p">]</span>
    <span class="c1"># separate P1 and P2</span>
    <span class="n">p1_df</span> <span class="o">=</span> <span class="n">gene_df</span><span class="p">[</span><span class="n">gene_df</span><span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P1&quot;</span><span class="p">]</span>
    <span class="n">p2_df</span> <span class="o">=</span> <span class="n">gene_df</span><span class="p">[</span><span class="n">gene_df</span><span class="p">[</span><span class="s2">&quot;Condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P2&quot;</span><span class="p">]</span>

    <span class="c1">#just calculate thge mean NES difference</span>
    <span class="n">mean_nes_p1</span> <span class="o">=</span> <span class="n">p1_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">mean_nes_p2</span> <span class="o">=</span> <span class="n">p2_df</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">nes_diff</span> <span class="o">=</span> <span class="n">mean_nes_p1</span> <span class="o">-</span> <span class="n">mean_nes_p2</span>
    <span class="n">nes_diff_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;Target_Gene&quot;</span><span class="p">:</span> <span class="n">gene</span><span class="p">,</span>
        <span class="s2">&quot;Mean_NES_P1&quot;</span><span class="p">:</span> <span class="n">mean_nes_p1</span><span class="p">,</span>
        <span class="s2">&quot;Mean_NES_P2&quot;</span><span class="p">:</span> <span class="n">mean_nes_p2</span><span class="p">,</span>
        <span class="s2">&quot;NES_Difference&quot;</span><span class="p">:</span> <span class="n">nes_diff</span>
    <span class="p">})</span>
<span class="n">nes_diff_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nes_diff_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nes_diff_df</span><span class="p">)</span>
<span class="c1">#plot the NES difference</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="c1">#order difference nes_diff_df</span>
<span class="n">nes_diff_df</span> <span class="o">=</span> <span class="n">nes_diff_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;NES_Difference&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#remove genes with nan values</span>
<span class="n">nes_diff_df</span> <span class="o">=</span> <span class="n">nes_diff_df</span><span class="p">[</span><span class="n">nes_diff_df</span><span class="p">[</span><span class="s2">&quot;NES_Difference&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">nes_diff_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;NES_Difference&quot;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Target Gene&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean NES Difference (P1 - P2)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Average NES Difference Between P1 and P2 Across Shared Pathways&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1">#save as a pdf</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/mean_NES_difference_P1_P2.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
   Target_Gene  Mean_NES_P1  Mean_NES_P2  NES_Difference
0          SP1       1.8865          NaN             NaN
1        TGIF1      -1.6060       1.9967         -3.6027
2         P4HB      -1.6885          NaN             NaN
3        NCOR2          NaN      -1.6075             NaN
4       JARID2      -1.4687      -1.6524          0.1836
5         ESR1       1.9448       0.7594          1.1854
6        PA2G4      -1.6153          NaN             NaN
7        GPBP1          NaN       1.9496             NaN
8        DHX30          NaN      -0.2122             NaN
9         SAFB          NaN      -1.4168             NaN
10        CHD8          NaN      -1.5998             NaN
11       SIN3A      -0.9079      -1.7137          0.8058
12       PSMC5      -1.7132       1.8945         -3.6077
13      GTF2F1       1.9189      -1.5914          3.5103
14        ADAR      -0.8903          NaN             NaN
15       NR2F2      -1.5661          NaN             NaN
16        BZW1       1.0284      -1.5607          2.5891
17         SET      -0.4655          NaN             NaN
18     MYBBP1A       1.8961      -1.6009          3.4971
19        CUX1       1.9624       2.0318         -0.0695
20         NBN          NaN       1.8661             NaN
21        CALR       1.5437          NaN             NaN
22       STAG2          NaN      -1.6416             NaN
23         PKM       1.2322      -1.5604          2.7926
24       BRIP1       0.7132      -1.5030          2.2162
25       GATA3          NaN      -1.4402             NaN
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/r_/bqnt2f_d6919cz7v1yzx2ykc0000gn/T/ipykernel_22880/2520638475.py:27: FutureWarning:

Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `x` variable to `hue` and set `legend=False` for the same effect.

  sns.barplot(data=nes_diff_df, x=&#34;Target_Gene&#34;, y=&#34;NES_Difference&#34;, palette=&#34;coolwarm&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_26_2.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_26_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#run for a single gene</span>
<span class="k">for</span> <span class="n">gene_of_interest</span> <span class="ow">in</span> <span class="n">nes_diff_df</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
    <span class="n">gsea_esr1_df</span><span class="p">,</span><span class="n">pre_res_ap</span><span class="p">,</span> <span class="n">pre_res_mp</span> <span class="o">=</span> <span class="n">run_gsea_for_gene</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gene_of_interest</span><span class="p">)</span>
    <span class="c1">#add together res2d from pre_res_ap and pre_res_mp</span>
    <span class="n">pre_res_ap</span><span class="o">.</span><span class="n">res2d</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;P2&quot;</span>
    <span class="n">pre_res_mp</span><span class="o">.</span><span class="n">res2d</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;P1&quot;</span>
    <span class="n">combined_res2d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pre_res_ap</span><span class="o">.</span><span class="n">res2d</span><span class="p">,</span> <span class="n">pre_res_mp</span><span class="o">.</span><span class="n">res2d</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">gseapy.scipalette</span><span class="w"> </span><span class="kn">import</span> <span class="n">SciPalette</span>
    <span class="n">sci</span> <span class="o">=</span> <span class="n">SciPalette</span><span class="p">()</span>
    <span class="n">NbDr</span> <span class="o">=</span> <span class="n">sci</span><span class="o">.</span><span class="n">create_colormap</span><span class="p">()</span>
    <span class="c1">#add new column name &#39;Adjusted P-value&#39; from FDR q-val</span>
    <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;Adjusted P-value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;NOM p-val&quot;</span><span class="p">]</span>
    <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;NES&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Up&quot;</span><span class="p">,</span> <span class="s2">&quot;Down&quot;</span><span class="p">)</span>
    <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;Promoter_Direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span>
    <span class="n">combined_res2d</span> <span class="o">=</span> <span class="n">combined_res2d</span><span class="p">[(</span><span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;NOM p-val&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">combined_res2d</span><span class="p">[</span><span class="s2">&quot;FDR q-val&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">dotplot</span><span class="p">(</span><span class="n">combined_res2d</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Promoter_Direction&#39;</span><span class="p">,</span>
                    <span class="n">x_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;P1_Up&quot;</span><span class="p">,</span><span class="s2">&quot;P1_Down&quot;</span><span class="p">,</span><span class="s2">&quot;P2_Up&quot;</span><span class="p">,</span><span class="s2">&quot;P2_Down&quot;</span><span class="p">],</span>
                    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;GSEA Dotplot for </span><span class="si">{</span><span class="n">gene_of_interest</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">NbDr</span><span class="o">.</span><span class="n">reversed</span><span class="p">(),</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">show_ring</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1">#make the size larger for plt.savefig</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gsea_dotplot_</span><span class="si">{</span><span class="n">gene_of_interest</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
    <span class="c1">#save plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_28_0.png" src="../../_images/scripts_3_analysis_scripts_8_perturbseq_differentialexpression_28_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_comp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">comp_gene_list</span><span class="p">))</span>
<span class="n">all_comp</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">MP</span><span class="o">.</span><span class="n">columns</span>
<span class="n">all_comp</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">all_comp</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">all_comp</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">all_comp</span><span class="p">[</span><span class="s2">&quot;Guide&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">all_comp_mean</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;logfoldchanges&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">})</span>
<span class="n">all_comp_mean</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">all_comp_mean</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span><span class="s2">&quot;logfoldchanges_mean&quot;</span><span class="p">]</span>
<span class="n">all_comp</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_comp_mean</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">)</span>
<span class="n">all_comp_mean</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;Target_Gene&#39;</span><span class="p">:</span><span class="s2">&quot;count&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">:</span><span class="s2">&quot;Count&quot;</span><span class="p">})</span>
<span class="n">all_comp_mean</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">all_comp</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_comp_mean</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">)</span>
<span class="n">all_comp</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Guide&quot;</span><span class="p">)</span>
<span class="n">all_comp</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_list_full.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Mutual_Exclusivity&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">]</span><span class="o">+</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">])</span>

<span class="n">n_term</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s2">&quot;alt-prom-crispr-fiveprime/reference/all_pivot_simple_nterm.txt&quot;</span><span class="p">)</span>
<span class="n">n_term</span><span class="o">=</span><span class="nb">all</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">n_term</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Gene_symbol&quot;</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">)</span>

<span class="n">n_term</span><span class="o">=</span><span class="n">n_term</span><span class="p">[[</span><span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Overlap_Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Mutual_Exclusivity&quot;</span><span class="p">,</span><span class="s2">&quot;Ensembl_ID&quot;</span><span class="p">,</span><span class="s2">&quot;Gene_symbol&quot;</span><span class="p">,</span><span class="s2">&quot;Nterminus_Change&quot;</span><span class="p">]]</span>
<span class="c1"># all_comp_pivot</span>
<span class="n">all_comp_all</span><span class="o">=</span><span class="n">all_comp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">n_term</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Target_Gene&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Gene_symbol&quot;</span> <span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
<span class="n">all_comp_all</span><span class="o">=</span><span class="n">all_comp_all</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Nterminus_Change&quot;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="6_perturbseq_tsne_kldivergence_umap.html" class="btn btn-neutral float-left" title="Quantitative individual UMAPs per gene of interest" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="7_cellphase_model.html" class="btn btn-neutral float-right" title="Cell Assignment Model from FUCCI-Matched Single-Cell Paper" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Helen King.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>