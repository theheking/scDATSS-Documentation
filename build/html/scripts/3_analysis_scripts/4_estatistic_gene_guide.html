

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-distance of P1 and P2 Knockdown &mdash; Isoform Specific Perturb-Seq  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Target gene and neighbouring gene expression" href="5_genekd_neighbouring_gene_expression.html" />
    <link rel="prev" title="Velocity and pyGSEA calculations of ESR1" href="9B_velocity_loom.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Isoform Specific Perturb-Seq
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Analysis Pipeline:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../promoter_identification.html">Promoter Identification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_design.html">Promoter Specific Guide Design</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../analysis_scripts.html">Analysis Scripts &amp; Pipelines</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#preprocessing-guide-calling">Preprocessing &amp; Guide Calling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#transcript-quantification">Transcript Quantification</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../analysis_scripts.html#transcriptional-divergence-e-stats-differential-expression">Transcriptional Divergence (E-Stats &amp; Differential Expression)</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">E-distance of P1 and P2 Knockdown</a></li>
<li class="toctree-l3"><a class="reference internal" href="5_genekd_neighbouring_gene_expression.html">Target gene and neighbouring gene expression</a></li>
<li class="toctree-l3"><a class="reference internal" href="6_perturbseq_tsne_kldivergence_umap.html">Quantitative individual UMAPs per gene of interest</a></li>
<li class="toctree-l3"><a class="reference internal" href="8_perturbseq_differentialexpression.html">Differential Expression analysis between P1 &amp; P2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#cell-phase-pathway-modeling">Cell Phase &amp; Pathway Modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analysis_scripts.html#clinical-promoter-prevalence">Clinical &amp; Promoter Prevalence</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Isoform Specific Perturb-Seq</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../analysis_scripts.html">Analysis Scripts &amp; Pipelines</a></li>
      <li class="breadcrumb-item active">E-distance of P1 and P2 Knockdown</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/scripts/3_analysis_scripts/4_estatistic_gene_guide.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="E-distance-of-P1-and-P2-Knockdown">
<h1>E-distance of P1 and P2 Knockdown<a class="headerlink" href="#E-distance-of-P1-and-P2-Knockdown" title="Link to this heading"></a></h1>
<ol class="arabic simple">
<li><p>Run through the 10x Cellranger pipeline and velocyto for single cell RNAseq quatification and using (2) guides quantifiction. all found in the cellranger files folder <strong>bash</strong></p></li>
<li><p>Guide Calling for dual guide. Use repogle method to take molecule.h5 generated by cellranger and py to run through repogle version of guide calling or use cellranger_guidecalling.ipynb for Direct Capture Perturb-Seq dual guide. Formed guide-specific lists of cells.</p></li>
<li><p>Pseudobulk analysis. A. Seperation of guide-specific fastq files. <strong>bash</strong> B. Whippet pseudobulk for transcript specific analysis, post UMI deduplication. <strong>bash</strong> C. Transcript quality control. <strong>R</strong> D. Whippet result visualisation.</p></li>
<li><p><strong>Normalisation of adata object and E-distance of KD</strong></p></li>
<li><p>Check gene and neighboring gene expression</p></li>
<li><p>Create individual umaps per gene of interest</p>
<ol class="upperalpha simple">
<li><p>UMAPs</p></li>
<li><p>Rand Index score</p></li>
</ol>
</li>
<li><p>Cell phase assignment model from FUCCI-matched single cell paper (GSE146773_)</p></li>
<li><p>Differential Expression analysis.</p>
<ol class="upperalpha simple">
<li><p>Find the shared P1 and P2 genes.</p></li>
<li><p>Check the shared P1 and P2 across different protospacers with the same A/B and C/D.</p></li>
</ol>
</li>
<li><p>CNV Score &amp; Numbat to quantify and Velocity quantification with loom file</p></li>
<li><p>ESR1-specific analysis from proliferation analysis to rt-qpcr</p></li>
<li><p>Spectra analysis and visualisation for pathway enrichment</p></li>
</ol>
<p>This script quantifies the global transcriptomic impact of each promoter-specific knockdown. This is done using the E-statistic (Energy distance), a metric better suited for the sparsity of single-cell data than traditional methods.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ad</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyensembl</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnsemblRelease</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">liftover</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_lifter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="c1">#import package from this locaton to be able to import /Users/helenking/Desktop/Weatheritt_Lab_Y2/alt-prom-crispr-fiveprime/scripts/apu_analysis</span>
<span class="n">loc</span><span class="o">=</span><span class="s2">&quot;/Users/helenking/Desktop/Weatheritt_Lab_Y2/alt-prom-crispr-fiveprime/&quot;</span>
<span class="n">fig_loc</span><span class="o">=</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;figures/&quot;</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;scripts/&#39;</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">apu_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scperturb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">infercnvpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cnv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">apu_analysis.cell_import</span><span class="w"> </span><span class="kn">import</span> <span class="n">CellPopulation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="c1"># colours using garvan</span>
<span class="n">color1</span> <span class="o">=</span><span class="s1">&#39;#4d00c7&#39;</span>
<span class="n">palecolor1</span><span class="o">=</span><span class="s2">&quot;#b366ff&quot;</span>
<span class="n">color2</span><span class="o">=</span> <span class="s1">&#39;#da3c07&#39;</span>
<span class="n">palecolor2</span><span class="o">=</span><span class="s2">&quot;#ff8954&quot;</span>
<span class="n">color3</span><span class="o">=</span><span class="s1">&#39;#05d3d3&#39;</span>
<span class="n">color4</span><span class="o">=</span><span class="s1">&#39;#c6c7c5&#39;</span>

<span class="c1">#use viridis</span>
<span class="n">color1</span><span class="o">=</span><span class="s2">&quot;#fde725&quot;</span>
<span class="n">color2</span><span class="o">=</span><span class="s2">&quot;#7ad151&quot;</span>
<span class="n">color3</span><span class="o">=</span><span class="s2">&quot;#22a884&quot;</span>
<span class="n">color4</span><span class="o">=</span><span class="s2">&quot;#2a788e&quot;</span>
<span class="n">color5</span><span class="o">=</span><span class="s2">&quot;#2a788e&quot;</span>
<span class="n">color6</span><span class="o">=</span><span class="s1">&#39;#440154&#39;</span>

<span class="c1">#hotpink yellow and blue</span>
<span class="n">color1</span><span class="o">=</span><span class="s1">&#39;#d81b61&#39;</span> <span class="c1">#true</span>
<span class="n">color2</span><span class="o">=</span><span class="s1">&#39;#fec111&#39;</span> <span class="c1">#false</span>
<span class="n">color3</span><span class="o">=</span><span class="s1">&#39;#2179b4&#39;</span> <span class="c1">#negative control</span>

<span class="c1">#protein level</span>
<span class="n">color1</span><span class="o">=</span><span class="s1">&#39;#3d82c4&#39;</span> <span class="c1">#true</span>
<span class="n">color2</span><span class="o">=</span><span class="s1">&#39;#2179b4&#39;</span> <span class="c1">#false</span>

<span class="c1"># Create the color palette</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">([</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color3</span><span class="p">])</span>
<span class="n">new_palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">([</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span><span class="n">color1</span><span class="p">,</span> <span class="n">color2</span><span class="p">,</span> <span class="n">color3</span><span class="p">,</span> <span class="n">color4</span><span class="p">])</span>
<span class="n">whippet_loc</span> <span class="o">=</span> <span class="s2">&quot;/Users/helenking/Library/CloudStorage/OneDrive-UNSW/PAPERS/CRISPRi_paper/Updated_FullLength/NAR_rebuttal/Supplementary_Information/Table_S4.xlsx&quot;</span>


<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scanpy&quot;</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Scanpy 1.10.3
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/helenking/anaconda3/envs/apu/lib/python3.12/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<p>Rather than looking at individual genes one by one, the code uses the e-distance to measure how much the entire transcriptome of a cell population changes after a specific promoter (P1 or P2) is knocked down compared to a control.</p>
<p>Dimensionality Reduction: The code first performs Principal Component Analysis (PCA) and UMAP embedding on the normalized single-cell data.</p>
<p>E-test Calculation: Using the scPerturb package, it calculates the Euclidean distance between these high-dimensional clusters. A significant e-distance indicates that the promoter knockdown created a unique “transcriptional landscape” distinct from the control.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">##this reads in the output from 10x as well as cell_indetities.csv which is a file that annotates each cell barcode with a</span>
<span class="c1">#cell_barcode,guide_identity,read_count,UMI_count,coverage,gemgroup,good_coverage,number_of_cells</span>
<span class="n">pop</span> <span class="o">=</span> <span class="n">CellPopulation</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;cellranger_output&#39;</span><span class="p">,</span>
                               <span class="n">genome</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">filtered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">raw_umi_threshold</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">strip_low_expression</span><span class="p">(</span><span class="n">pop</span><span class="p">)</span>

<span class="c1">#create list of nontargeting guides</span>
<span class="n">nontargeting_control</span><span class="o">=</span><span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Neg&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;non&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Non&quot;</span><span class="p">)</span><span class="o">|</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgNegC&quot;</span><span class="p">))]</span>
<span class="n">non_targeting_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">nontargeting_control</span><span class="p">))</span>

<span class="c1">#add perturbation column to the pop.cells dataframe</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">non_targeting_list</span><span class="p">),</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">,</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;sg&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

<span class="c1">#seperately annotate the positive control guides</span>
<span class="n">pos_control</span><span class="o">=</span><span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgRPL3&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgSNRPD&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgATF5&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgGINS1&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgRPL31A&quot;</span><span class="p">)</span><span class="o">|</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sgSNRPD&quot;</span><span class="p">))]</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos_control</span><span class="p">),</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">])</span>

<span class="c1">#add a column for the promoter type</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;guide_identity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">][(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;00&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;01&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;02&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;03&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;Control&quot;</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="c1">#add certain filters and add information</span>
<span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="o">=</span><span class="n">add_filter_columns</span><span class="p">(</span><span class="n">input_dataframe</span><span class="o">=</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;cell_barcode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading digital expression data: /Users/helenking/Desktop/Weatheritt_Lab_Y2/alt-prom-crispr-fiveprime/cellranger_output/filtered_feature_bc_matrix/matrix.mtx...
Densifying matrix...
Loading guide identities:/Users/helenking/Desktop/Weatheritt_Lab_Y2/alt-prom-crispr-fiveprime/cellranger_output/cell_identities.csv...
Generating summary statistics...
Done.
(28365, 25) 28365
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/adata_normalised_cellcycle.h5ad&quot;</span><span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;log1p&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;processed&#39;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The dataset is already processed. Skipping processing...&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pop</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="s2">&quot;cell_barcode&quot;</span><span class="p">]])</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">cells</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span> <span class="o">=</span> <span class="n">pop</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">columns</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_barcode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">var_names_make_unique</span><span class="p">()</span>
  <span class="c1">#remove any na values from</span>
  <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()),:]</span>
  <span class="c1">#remove all genes that start with sg</span>
  <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[:,</span><span class="o">~</span><span class="p">((</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sg&#39;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;non&#39;</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Non&#39;</span><span class="p">)))]</span>
  <span class="n">whippet</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;/Supplementary_Information/Table_S4.xlsx&quot;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;guide_target&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;guide_target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sg&quot;</span><span class="p">),</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;guide_target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">)</span>
  <span class="c1">#merge on the lhs with whippet</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">whippet</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;guide_target&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_barcode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

  <span class="c1">#import another</span>
  <span class="n">adata2</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_10x_mtx</span><span class="p">(</span><span class="s2">&quot;alt-prom-crispr-fiveprime/cellranger_output/filtered_feature_bc_matrix&quot;</span><span class="p">)</span>
  <span class="c1">#add pop2 to pop #get the same genes and cells as adata</span>
  <span class="c1">#list of genes found in both</span>
  <span class="n">genes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata2</span><span class="o">.</span><span class="n">var_names</span><span class="p">))</span>
  <span class="c1">#list of cells found in both</span>
  <span class="n">cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata2</span><span class="o">.</span><span class="n">obs_names</span><span class="p">))</span>
  <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">[</span><span class="n">cells</span><span class="p">,</span><span class="n">genes</span><span class="p">]</span>
  <span class="n">adata2</span><span class="o">=</span><span class="n">adata2</span><span class="p">[</span><span class="n">cells</span><span class="p">,</span><span class="n">genes</span><span class="p">]</span>
  <span class="c1">#add the X from adata2 to adata</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="n">adata2</span><span class="o">.</span><span class="n">X</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
  <span class="n">mitochondrial_genes</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">mitochondrial_genes</span><span class="p">(</span><span class="s2">&quot;hsapiens&quot;</span><span class="p">,</span><span class="n">attrname</span><span class="o">=</span><span class="s2">&quot;hgnc_symbol&quot;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;mt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mitochondrial_genes</span><span class="p">[</span><span class="s2">&quot;hgnc_symbol&quot;</span><span class="p">])</span> <span class="c1"># annotate the group of mitochondrial genes as &#39;mt&#39;</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">calculate_qc_metrics</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">qc_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mt&#39;</span><span class="p">],</span> <span class="n">percent_top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log1p</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="c1"># basic qc and pp</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_cells</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_counts</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_per_cell</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
  <span class="c1">#save the log1p normalised matrix</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;log1p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;pct_counts_mt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;mt&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># sanity cleaning</span>

  <span class="c1"># select HVGs</span>
  <span class="n">n_var_max</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># max total features to select</span>

  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="n">n_var_max</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;seurat_v3&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_highly_variable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;processed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;good_coverage&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;good_coverage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
  <span class="n">adata</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/adata_normalised.h5ad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The dataset is already processed. Skipping processing...
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;log_guide_UMI_count&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_UMI_count&quot;</span><span class="p">])</span>
<span class="c1"># adata.write_csvs(loc+&#39;files/adata_normalised/&#39;)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">violin</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;log_guide_UMI_count&quot;</span><span class="p">,</span><span class="s2">&quot;n_genes_by_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;total_counts&quot;</span><span class="p">,</span> <span class="s2">&quot;pct_counts_mt&quot;</span><span class="p">],</span>
    <span class="n">jitter</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
    <span class="n">multi_panel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;qc.png&quot;</span>
<span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: saving figure to file figures/violinqc.png
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_7_1.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_7_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;highly_variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pct_dropout_by_counts&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">new_palette</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: xlabel=&#39;highly_variable&#39;, ylabel=&#39;pct_dropout_by_counts&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_8_1.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_8_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_twoprom</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;perturbation&quot;</span><span class="p">])[</span><span class="s2">&quot;promoter_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">list_twoprom</span><span class="p">[</span><span class="n">list_twoprom</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="c1">#apply the function to every gene that has both MP and AP promoter type</span>
<span class="c1">#create a column to chekc if both AP and MP</span>
<span class="n">perturb</span><span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">][(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;perturbation&quot;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;two&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">perturb</span><span class="o">=</span><span class="n">perturb</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="c1">#choose the</span>
<span class="n">grouping_variable</span><span class="o">=</span><span class="s2">&quot;guide_id&quot;</span>
<span class="n">negative_control</span><span class="o">=</span><span class="s2">&quot;non-targeting_Control&quot;</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/edist_perprom.csv&quot;</span><span class="p">):</span>
    <span class="c1">#read in the edistcsv</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/edist_perprom.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">##remove the non-targeting guides</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;neglog10_pvalue_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pvalue_adj&#39;</span><span class="p">])</span>
    <span class="c1">#import the gene to 5&#39; UTR annotation file</span>
    <span class="n">nterm</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/reference/all_pivot_simple_nterm.txt&quot;</span><span class="p">)</span>
    <span class="c1">#color the violin plot above with the 5&#39;UTR annotation</span>
    <span class="n">df</span><span class="o">=</span><span class="n">nterm</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;Gene_symbol&quot;</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;edist&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span>
    <span class="n">whippet</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">whippet_loc</span><span class="p">)</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">whippet</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="c1"># df=df[df[&quot;successfulKD&quot;]==True]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">df_list</span><span class="o">=</span><span class="p">[</span><span class="n">test_edist_perprom</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">grouping_variable</span><span class="p">,</span> <span class="n">negative_control</span><span class="p">)</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">perturb</span><span class="p">]</span>
    <span class="c1">#flatten the df_list</span>
    <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/edist_perprom.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Comparative Analysis of P1 vs. P2 Knockdowns A major goal of the paper is to see if P1 and P2 promoters of the same gene do different things.</p>
<p>Direct Comparison: The notebook computes the e-distance between the P1-targeted population and the P2-targeted population.</p>
<p>Results Found: The authors report that 51.6% (16/31) of surveyed genes showed significant transcriptomic divergence between P1 and P2 knockdowns. This proves that these alternative promoters are not redundant but regulate different biological pathways</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>

<span class="n">scat</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;neglog10_pvalue_adj&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;significant_adj&#39;</span><span class="p">,</span>
                     <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;tab:pink&#39;</span><span class="p">,</span> <span class="s1">&#39;Non-Targeting&#39;</span><span class="p">:</span> <span class="s1">&#39;tab:orange&#39;</span><span class="p">},</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;E-test results&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;E-distance between P1 and P2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;E-test neg log10 of adjusted p-value&#39;</span><span class="p">)</span>
<span class="n">scat</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;etest_pvalue_adj.pdf&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_12_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_12_0.png" />
</div>
</div>
<p>Biological and Structural Annotations The code merges statistical results with biological data to interpret the findings:</p>
<p>N-Terminus Changes: It checks if the start codon (ATG) is located between the two promoters. If it is, the P1 and P2 transcripts will produce different protein isoforms, likely leading to the observed divergence in the e-statistic.</p>
<p>Clustering Performance: The code uses Rand Scores and Mutual Information Scores to evaluate how well unsupervised clustering (like HDBSCAN) can distinguish between P1 and P2 cells.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
<span class="c1">#put two colors d81b61 fec111</span>
<span class="n">palette_new</span><span class="o">=</span><span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;#d81b61&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;#fec111&quot;</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span>   <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>  <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;significant_adj&#39;</span><span class="p">,</span><span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette_new</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;significant_adj&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;edist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;edist&quot;</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">),</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#label esr1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;E-Distance to Non-Targeting&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of E-Distances betwen P1 and P2&#39;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_violinplot.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
<span class="c1">#change palette_two 5UTR #2279b4 Nterminus #50bc83</span>
<span class="n">palette_two</span><span class="o">=</span><span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;#2279b4&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;#50bc83&quot;</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>  <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>  <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Nterminus_Change&#39;</span><span class="p">,</span><span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette_two</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;E-Distance to Non-Targeting&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_violinplot_utr.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/edist_results.csv&quot;</span><span class="p">)</span>
<span class="c1">#extract the significant genes above</span>
<span class="n">significant_genes</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;significant_adj&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;edist&quot;</span><span class="p">)</span>
<span class="n">significant_genes</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/significant_genes.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_14_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_14_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_14_1.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_14_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#save df to Downloads</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;/Users/helenking/Downloads/edist_results_full.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Correlation with Promoter Usage The authors use this notebook to investigate if the “strength” of a promoter (its baseline TPM) predicts its functional impact.</p>
<p>Key Findings: The analysis (visualized in pairwise correlation matrices) showed no meaningful correlation between a promoter’s usage fraction and the resulting e-distance. This means even a weakly expressed alternative promoter can trigger a massive global change in the cell’s transcriptome</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- column names for P1 ---</span>
<span class="n">x_p1</span> <span class="o">=</span> <span class="s1">&#39;edist&#39;</span>
<span class="n">y_p1</span> <span class="o">=</span> <span class="s1">&#39;% KD of Non-Targeted P1 Isoforms against NTC&#39;</span>

<span class="c1"># --- column names for P2 ---</span>
<span class="n">x_p2</span> <span class="o">=</span> <span class="s1">&#39;edist&#39;</span>
<span class="n">y_p2</span> <span class="o">=</span> <span class="s1">&#39;% KD of Non-Targeted P2 Isoforms against NTC&#39;</span>

<span class="c1"># significance column</span>
<span class="n">sig_col</span> <span class="o">=</span> <span class="s1">&#39;significant&#39;</span>

<span class="c1"># label column</span>
<span class="n">label_col</span> <span class="o">=</span> <span class="s1">&#39;Gene_symbol&#39;</span>

<span class="c1"># Convert all relevant columns to numeric</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x_p1</span><span class="p">,</span> <span class="n">y_p1</span><span class="p">,</span> <span class="n">y_p2</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Keep only rows with data</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">x_p1</span><span class="p">,</span> <span class="n">y_p1</span><span class="p">,</span> <span class="n">y_p2</span><span class="p">,</span> <span class="n">sig_col</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># --- Remove problematic values for log-scale ---</span>
<span class="c1"># log-scale cannot handle 0, negative, or extremely small e-distances</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">x_p1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">]</span>

<span class="c1"># Detect outliers using IQR</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_outliers</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">iqr</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">iqr</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">series</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span>

<span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">y_p1</span><span class="p">])</span>
<span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">y_p2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Pull arrays</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_p1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>          <span class="c1"># e-distance (same for P1 &amp; P2)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>         <span class="c1"># %KD P1</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>         <span class="c1"># %KD P2</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>     <span class="c1"># boolean significance</span>

<span class="c1"># Keep only positive x for log scale</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Work in log10(x) space for KDE stability</span>
<span class="n">x_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Grid for KDE evaluation</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">x_log</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_log</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y2</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># 2D KDE for P1</span>
<span class="n">kde1</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_log</span><span class="p">,</span> <span class="n">y1</span><span class="p">]))</span>
<span class="n">z1</span> <span class="o">=</span> <span class="n">kde1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># 2D KDE for P2</span>
<span class="n">kde2</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_log</span><span class="p">,</span> <span class="n">y2</span><span class="p">]))</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">kde2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Convert grid x back to linear scale for plotting</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">xx</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># --- KDE contours (sns.kdeplot-style) --- #</span>
<span class="c1"># P1: red contour lines</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
    <span class="n">x_grid</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># P2: blue contour lines</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
    <span class="n">x_grid</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># --- Scatter points --- #</span>
<span class="c1"># Light, semi-transparent points</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P1 KD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P2 KD&quot;</span><span class="p">)</span>

<span class="c1"># Highlight significant e-distance points with outlined markers</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span>
    <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;darkred&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P1 significant&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span>
    <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;navy&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P2 significant&quot;</span>
<span class="p">)</span>

<span class="c1"># Axes &amp; labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-distance (P1 vs P2)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;% KD Non-targeted isoforms&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;E-distance vs %KD with 2D KDE contours</span><span class="se">\n</span><span class="s2">P1 (red) and P2 (blue)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="c1">#add correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="n">corr_p1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
<span class="n">corr_p2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;P1 Pearson r: </span><span class="si">{</span><span class="n">corr_p1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 Pearson r: </span><span class="si">{</span><span class="n">corr_p2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="c1"># add correlation for significant points only</span>
<span class="n">corr_p1_sig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>
<span class="n">corr_p2_sig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;P1 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p1_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p2_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#save</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_kde_contours_off.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#print all the correlatiosn</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P1 Pearson r: </span><span class="si">{</span><span class="n">corr_p1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 Pearson r: </span><span class="si">{</span><span class="n">corr_p2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P1 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p1_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p2_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_18_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_18_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
P1 Pearson r: 0.13
P2 Pearson r: 0.05
P1 sig Pearson r: 0.07
P2 sig Pearson r: 0.00
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edistance_full_all.csv&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already run edistance and etest between negative control and all other guides&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edistance_full_all.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;neglog10_pvalue_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pvalue_adj&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span>
    <span class="n">whippet</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">whippet_loc</span><span class="p">)</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">whippet</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1">#rerun the same as above but instead of between</span>
    <span class="n">grouping_variable</span><span class="o">=</span><span class="s2">&quot;guide_id&quot;</span>
    <span class="n">negative_control</span><span class="o">=</span><span class="s2">&quot;non-targeting_Control&quot;</span>

    <span class="c1"># grouping_variable=&quot;guide_assignment&quot;</span>
    <span class="c1"># negative_control=&quot;non-targeting&quot;</span>
    <span class="n">adata_sgRNA</span><span class="o">=</span><span class="n">adata</span>
    <span class="n">adata_sgRNA</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adata_sgRNA</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_target&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">,</span><span class="s2">&quot;non-targeting&quot;</span><span class="p">,</span><span class="n">adata_sgRNA</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;guide_assignment&quot;</span><span class="p">])</span>
    <span class="n">data_sgRNA</span> <span class="o">=</span> <span class="n">scperturb</span><span class="o">.</span><span class="n">equal_subsampling</span><span class="p">(</span><span class="n">adata_sgRNA</span><span class="p">,</span> <span class="n">grouping_variable</span><span class="p">,</span> <span class="n">N_min</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">data_sgRNA</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># sanity cleaning</span>

    <span class="c1"># select HVGs</span>
    <span class="n">n_var_max</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># max total features to select</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">data_sgRNA</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="n">n_var_max</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;seurat_v3&#39;</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">data_sgRNA</span><span class="p">,</span> <span class="n">use_highly_variable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">data_sgRNA</span><span class="p">)</span>
    <span class="n">estats</span> <span class="o">=</span> <span class="n">scperturb</span><span class="o">.</span><span class="n">edist</span><span class="p">(</span><span class="n">adata_sgRNA</span><span class="p">,</span><span class="n">obs_key</span><span class="o">=</span><span class="n">grouping_variable</span><span class="p">,</span> <span class="n">obsm_key</span><span class="o">=</span><span class="s1">&#39;X_pca&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;sqeuclidean&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">scperturb</span><span class="o">.</span><span class="n">etest</span><span class="p">(</span><span class="n">adata_sgRNA</span><span class="p">,</span> <span class="n">obs_key</span><span class="o">=</span><span class="n">grouping_variable</span><span class="p">,</span> <span class="n">obsm_key</span><span class="o">=</span><span class="s1">&#39;X_pca&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;sqeuclidean&#39;</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="n">negative_control</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#filter df</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edistance_full_all.csv&quot;</span><span class="p">)</span>
    <span class="c1">#save two versions one per guide and one per perturbation</span>
    <span class="c1"># df = pd.read_csv(loc+&quot;/files/singlecell_shortread_analysis/edistance_full_all.csv&quot;)</span>
        <span class="c1"># index=tuple(zip(estats.index.str.split(&#39;_&#39;).str[0].to_list(),estats.index.str.split(&#39;_&#39;).str[1].to_list()))</span>
    <span class="n">columns</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">estats</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span><span class="n">estats</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()))</span>
    <span class="n">estats</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">estats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">estats</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
    <span class="n">order_estats</span><span class="o">=</span><span class="n">estats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="n">order</span><span class="p">]</span>
    <span class="n">order_estats</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">order_estats</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">order_estats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">order_estats</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sns_plot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">order_estats</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;E-distance&#39;</span><span class="p">})</span>
    <span class="c1">#save to pdf</span>
    <span class="n">sns_plot</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_heatmap.pdf&quot;</span><span class="p">)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Already run edistance and etest between negative control and all other guides
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edistance_full_all.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;MP&quot;</span><span class="p">,</span><span class="s2">&quot;P1&quot;</span><span class="p">,</span><span class="s2">&quot;P2&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;edist_neg&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;promoter&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;P2&quot;</span><span class="p">,</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">],</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">])</span>

<span class="c1">#split edist to be p1 and p2</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;promoter&quot;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">,</span><span class="s2">&quot;edist_neg&quot;</span><span class="p">,</span><span class="s2">&quot;pvalue&quot;</span><span class="p">,</span><span class="s2">&quot;significant&quot;</span><span class="p">,</span><span class="s2">&quot;pvalue_adj&quot;</span><span class="p">,</span><span class="s2">&quot;promoter&quot;</span><span class="p">])</span>
<span class="c1">#change the columns to be flattened</span>
<span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="c1"># df[&#39;neglog10_pvalue_adj_P1&#39;] = -np.log10(df[&#39;pvalue_adj_P1&#39;],where=df[&#39;pvalue_adj_P1&#39;]!=0)</span>
<span class="c1"># df[&#39;neglog10_pvalue_adj_P2&#39;] = -np.log10(df[&#39;pvalue_adj_P2&#39;], where=df[&#39;pvalue_adj_P2&#39;]!=0)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
<span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



<span class="c1">#repeat with the ntc relative to the other guides</span>
<span class="n">df_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edist_perprom.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#remove the non-targeting guides</span>
<span class="n">df_2</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">[</span><span class="n">df_2</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_2</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df_2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;neglog10_pvalue_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df_2</span><span class="p">[</span><span class="s1">&#39;pvalue_adj&#39;</span><span class="p">])</span>
<span class="c1">#merge the two dataframes</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_ntc&#39;</span><span class="p">))</span>

<span class="c1">#repeat with 1000</span>
<span class="n">df_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;/files/singlecell_shortread_analysis/edist_perprom_10000.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#remove the non-targeting guides</span>
<span class="n">df_3</span> <span class="o">=</span> <span class="n">df_3</span><span class="p">[</span><span class="n">df_3</span><span class="p">[</span><span class="s2">&quot;pvalue&quot;</span><span class="p">]</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_3</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df_3</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df_3</span><span class="p">[</span><span class="s1">&#39;neglog10_pvalue_adj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df_3</span><span class="p">[</span><span class="s1">&#39;pvalue_adj&#39;</span><span class="p">])</span>
<span class="c1">#merge the two dataframes</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_3</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_ten&#39;</span><span class="p">))</span>
<span class="n">whippet</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">whippet_loc</span><span class="p">)</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">whippet</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
<span class="c1">#if the promoter is P2 then the edist is negative</span>
<span class="n">df_melt</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">,</span><span class="s2">&quot;edist_neg_P1&quot;</span><span class="p">,</span><span class="s2">&quot;significant_P1&quot;</span><span class="p">]]</span>
<span class="n">df_melt</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">,</span><span class="s2">&quot;edist_neg&quot;</span><span class="p">,</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span>
<span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;P1&quot;</span>
<span class="n">df_melt_2</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">,</span><span class="s2">&quot;edist_neg_P2&quot;</span><span class="p">,</span><span class="s2">&quot;significant_P2&quot;</span><span class="p">]]</span>
<span class="n">df_melt_2</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">,</span><span class="s2">&quot;edist_neg&quot;</span><span class="p">,</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span>
<span class="n">df_melt_2</span><span class="p">[</span><span class="s2">&quot;promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;P2&quot;</span>
<span class="n">df_melt</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_melt</span><span class="p">,</span><span class="n">df_melt_2</span><span class="p">])</span>

<span class="n">df_melt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gene</th>
      <th>successfulKD</th>
      <th>edist_neg</th>
      <th>significant</th>
      <th>promoter</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ADAR</td>
      <td>True</td>
      <td>0.3534</td>
      <td>True</td>
      <td>P1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AHCYL1</td>
      <td>True</td>
      <td>0.7402</td>
      <td>True</td>
      <td>P1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>APP</td>
      <td>True</td>
      <td>0.3667</td>
      <td>True</td>
      <td>P1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ARNT</td>
      <td>False</td>
      <td>9.8101</td>
      <td>True</td>
      <td>P1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BRIP1</td>
      <td>True</td>
      <td>10.0487</td>
      <td>True</td>
      <td>P1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>37</th>
      <td>STAU2</td>
      <td>False</td>
      <td>-0.1702</td>
      <td>False</td>
      <td>P2</td>
    </tr>
    <tr>
      <th>38</th>
      <td>TGIF1</td>
      <td>True</td>
      <td>-1.5769</td>
      <td>True</td>
      <td>P2</td>
    </tr>
    <tr>
      <th>39</th>
      <td>TPD52L1</td>
      <td>False</td>
      <td>-0.9610</td>
      <td>True</td>
      <td>P2</td>
    </tr>
    <tr>
      <th>40</th>
      <td>YWHAZ</td>
      <td>True</td>
      <td>-1.8761</td>
      <td>True</td>
      <td>P2</td>
    </tr>
    <tr>
      <th>41</th>
      <td>ZNF3</td>
      <td>True</td>
      <td>-0.0666</td>
      <td>False</td>
      <td>P2</td>
    </tr>
  </tbody>
</table>
<p>84 rows × 5 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="c1">#show the esr1 gene with x and y of</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_melt</span><span class="p">[</span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist_neg&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;significant&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;E-Distance to Non-Targeting&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Gene (Successful KD)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Gene (Successful KD)&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_21_1.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_21_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;gene_promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;promoter&quot;</span><span class="p">]</span>
<span class="c1"># 1) Ensure a single numeric &#39;edist&#39; column</span>
<span class="n">df_melt</span> <span class="o">=</span> <span class="n">df_melt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;edist_neg&quot;</span><span class="p">]),</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

<span class="c1"># 2) Remove duplicate columns (keeps first occurrence)</span>
<span class="k">if</span> <span class="n">df_melt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
    <span class="n">df_melt</span> <span class="o">=</span> <span class="n">df_melt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df_melt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

<span class="n">subset</span> <span class="o">=</span> <span class="n">df_melt</span><span class="p">[</span><span class="n">df_melt</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">])</span>

<span class="n">palette_new</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;#d81b61&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;#fec111&quot;</span><span class="p">}</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># Horizontal orientation so edist is on X</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;edist&quot;</span><span class="p">,</span> <span class="n">inner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">swarmplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;edist&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;significant&quot;</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
              <span class="n">palette</span><span class="o">=</span><span class="n">palette_new</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>

<span class="c1"># Slight transparency</span>
<span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="n">ax1</span><span class="o">.</span><span class="n">collections</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">coll</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>

<span class="c1"># 3) Label top-5 by edist (force scalar extraction)</span>
<span class="n">top5</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;edist&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">top5</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c1"># convert to scalar robustly even if something odd slips in</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;edist&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">ed</span> <span class="o">+</span> <span class="n">jitter</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;gene_promoter&quot;</span><span class="p">]),</span>
             <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-Distance to Non-Targeting Control&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Significant&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="c1">#save to pdf</span>
<span class="n">fig</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_violinplot_perpromoter_ntc.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_22_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_22_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">top5</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>gene</th>
      <th>successfulKD</th>
      <th>edist_neg</th>
      <th>significant</th>
      <th>promoter</th>
      <th>gene_promoter</th>
      <th>edist</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>8</th>
      <td>CUX1</td>
      <td>True</td>
      <td>1.9719</td>
      <td>True</td>
      <td>P1</td>
      <td>CUX1_P1</td>
      <td>1.9719</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BRIP1</td>
      <td>True</td>
      <td>10.0487</td>
      <td>True</td>
      <td>P1</td>
      <td>BRIP1_P1</td>
      <td>10.0487</td>
    </tr>
    <tr>
      <th>26</th>
      <td>PSMC5</td>
      <td>True</td>
      <td>14.1426</td>
      <td>True</td>
      <td>P1</td>
      <td>PSMC5_P1</td>
      <td>14.1426</td>
    </tr>
    <tr>
      <th>12</th>
      <td>GATA3</td>
      <td>True</td>
      <td>-15.9471</td>
      <td>True</td>
      <td>P2</td>
      <td>GATA3_P2</td>
      <td>15.9471</td>
    </tr>
    <tr>
      <th>17</th>
      <td>MYBBP1A</td>
      <td>True</td>
      <td>-23.7559</td>
      <td>True</td>
      <td>P2</td>
      <td>MYBBP1A_P2</td>
      <td>23.7559</td>
    </tr>
    <tr>
      <th>14</th>
      <td>GTF2F1</td>
      <td>True</td>
      <td>25.0637</td>
      <td>True</td>
      <td>P1</td>
      <td>GTF2F1_P1</td>
      <td>25.0637</td>
    </tr>
    <tr>
      <th>17</th>
      <td>MYBBP1A</td>
      <td>True</td>
      <td>26.3313</td>
      <td>True</td>
      <td>P1</td>
      <td>MYBBP1A_P1</td>
      <td>26.3313</td>
    </tr>
    <tr>
      <th>10</th>
      <td>ESR1</td>
      <td>True</td>
      <td>-33.7209</td>
      <td>True</td>
      <td>P2</td>
      <td>ESR1_P2</td>
      <td>33.7209</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot two scatterplot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="c1">#plot edistance p1 and p2</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;edist_ten&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;successfulKD&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1">#hide the legend</span>
<span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="c1">#plot the correlation between the two</span>
<span class="n">corr</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;edist&quot;</span><span class="p">,</span><span class="s2">&quot;edist_ten&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Correlation: </span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
<span class="c1">#plot the pvalue adj</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;pvalue_adj&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;pvalue_adj_ten&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;successfulKD&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">corr</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;pvalue_adj&quot;</span><span class="p">,</span><span class="s2">&quot;pvalue_adj_ten&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="c1">#mvoe the legend outisde</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Successful KD&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span>  <span class="mf">0.8</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Correlation: </span><span class="si">{</span><span class="n">corr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
<span class="c1">#label the points that are outliers from the correlation</span>
<span class="c1">#change the x-axis</span>
<span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-distance to NTC (runs=10000)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;E-distance to NTC (runs=2000)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;p.value to NTC (runs=10000)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;E-distance to NTC (runs=2000)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pvalue_adj&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;pvalue_adj_ten&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.3</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">ax1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;pvalue_adj_ten&quot;</span><span class="p">],</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;pvalue_adj&quot;</span><span class="p">],</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_24_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_24_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- column names for P1 ---</span>
<span class="n">x_p1</span> <span class="o">=</span> <span class="s1">&#39;edist_P1&#39;</span>
<span class="n">y_p1</span> <span class="o">=</span> <span class="s1">&#39;% KD of targeted P1 Isoforms against NTC&#39;</span>

<span class="c1"># --- column names for P2 ---</span>
<span class="n">x_p2</span> <span class="o">=</span> <span class="s1">&#39;edist_P2&#39;</span>
<span class="n">y_p2</span> <span class="o">=</span> <span class="s1">&#39;% KD of Targeted P2 Isoforms against NTC&#39;</span>

<span class="c1"># significance column</span>
<span class="n">sig_col</span> <span class="o">=</span> <span class="s1">&#39;significant&#39;</span>

<span class="c1"># label column</span>
<span class="n">label_col</span> <span class="o">=</span> <span class="s1">&#39;gene&#39;</span>

<span class="c1"># Convert all relevant columns to numeric</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x_p1</span><span class="p">,</span> <span class="n">y_p1</span><span class="p">,</span> <span class="n">x_p2</span><span class="p">,</span> <span class="n">y_p2</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Keep only rows with data</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">x_p1</span><span class="p">,</span> <span class="n">y_p1</span><span class="p">,</span> <span class="n">x_p2</span><span class="p">,</span> <span class="n">y_p2</span><span class="p">,</span> <span class="n">sig_col</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="c1"># --- Remove problematic values for log-scale ---</span>
<span class="c1"># log-scale cannot handle 0, negative, or extremely small e-distances</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">x_p1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">x_p2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">)]</span>

<span class="c1"># Detect outliers using IQR</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_outliers</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="n">q1</span><span class="p">,</span> <span class="n">q3</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">iqr</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">iqr</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">series</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="n">upper</span><span class="p">)</span>

<span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">y_p1</span><span class="p">])</span>
<span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">y_p2</span><span class="p">])</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">adjustText</span><span class="w"> </span><span class="kn">import</span> <span class="n">adjust_text</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># -------- P1 panel -------- #</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df_clean</span><span class="p">[</span><span class="n">x_p1</span><span class="p">],</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p1</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">}),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">)</span>

<span class="n">label_mask</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span> <span class="o">|</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p1&#39;</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">label_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">row</span><span class="p">[</span><span class="n">x_p1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">y_p1</span><span class="p">],</span>
        <span class="n">row</span><span class="p">[</span><span class="n">label_col</span><span class="p">],</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span>
    <span class="p">)</span>
    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-distance (P1 vs P2)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;% KD targeted P1&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;P1: E-distance vs %KD</span><span class="se">\n</span><span class="s2">(blue = significant e-distance)&quot;</span><span class="p">)</span>

<span class="c1"># Let adjustText move labels to avoid overlap</span>
<span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>

<span class="c1"># -------- P2 panel -------- #</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">df_clean</span><span class="p">[</span><span class="n">x_p2</span><span class="p">],</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p2</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">}),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span>
<span class="p">)</span>

<span class="n">label_mask</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span> <span class="o">|</span> <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;outlier_p2&#39;</span><span class="p">]</span>
<span class="n">texts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">label_mask</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">row</span><span class="p">[</span><span class="n">x_p2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">y_p2</span><span class="p">],</span>
        <span class="n">row</span><span class="p">[</span><span class="n">label_col</span><span class="p">],</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span>
    <span class="p">)</span>
    <span class="n">texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-distance (P2)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;% KD targeted P2&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;P2: E-distance vs %KD</span><span class="se">\n</span><span class="s2">(blue = significant e-distance)&quot;</span><span class="p">)</span>

<span class="n">adjust_text</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_25_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_25_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Pull arrays</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_p1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>          <span class="c1"># e-distance (same for P1 &amp; P2)</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>         <span class="c1"># %KD P1</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_p2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>          <span class="c1"># e-distance (same for P1 &amp; P2)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">y_p2</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>         <span class="c1"># %KD P2</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">sig_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>     <span class="c1"># boolean significance</span>

<span class="c1"># Keep only positive x for log scale</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># Work in log10(x) space for KDE stability</span>
<span class="n">x1_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
<span class="n">x2_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>


<span class="c1"># Grid for KDE evaluation</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1_log</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x2_log</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x1_log</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">x2_log</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y2</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y1</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y2</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="mi">200</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># 2D KDE for P1</span>
<span class="n">kde1</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x1_log</span><span class="p">,</span> <span class="n">y1</span><span class="p">]))</span>
<span class="n">z1</span> <span class="o">=</span> <span class="n">kde1</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># 2D KDE for P2</span>
<span class="n">kde2</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x2_log</span><span class="p">,</span> <span class="n">y2</span><span class="p">]))</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">kde2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Convert grid x back to linear scale for plotting</span>
<span class="n">x_grid</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">xx</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># --- KDE contours (sns.kdeplot-style) --- #</span>
<span class="c1"># P1: red contour lines</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
    <span class="n">x_grid</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># P2: blue contour lines</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
    <span class="n">x_grid</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span>
    <span class="n">levels</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
    <span class="n">linewidths</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># --- Scatter points --- #</span>
<span class="c1"># Light, semi-transparent points</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P1 KD&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P2 KD&quot;</span><span class="p">)</span>

<span class="c1"># Highlight significant e-distance points with outlined markers</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x1</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span>
    <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;darkred&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P1 significant&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x2</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span>
    <span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s2">&quot;navy&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;P2 significant&quot;</span>
<span class="p">)</span>

<span class="c1"># Axes &amp; labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;E-distance (P1/P2 vs NTC)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;% KD targeted isoforms&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="c1">#add correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="n">corr_p1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
<span class="n">corr_p2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;P1 Pearson r: </span><span class="si">{</span><span class="n">corr_p1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 Pearson r: </span><span class="si">{</span><span class="n">corr_p2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="c1"># add correlation for significant points only</span>
<span class="n">corr_p1_sig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>
<span class="n">corr_p2_sig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;P1 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p1_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p2_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#save</span>
<span class="c1">#print all the correlatiosn</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P1 Pearson r: </span><span class="si">{</span><span class="n">corr_p1</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 Pearson r: </span><span class="si">{</span><span class="n">corr_p2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P1 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p1_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">P2 sig Pearson r: </span><span class="si">{</span><span class="n">corr_p2_sig</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;edistance_kde_contours.pdf&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
P1 Pearson r: -0.21
P2 Pearson r: 0.02
P1 sig Pearson r: -0.39
P2 sig Pearson r: 0.06
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_26_1.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_26_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot TPM Non-Targeted P1 Isoforms sum TPM Non-Targeted P2 Isoforms % KD of Targeted P2 Isoforms against NTC</span>
<span class="c1">#add df</span>
<span class="c1">#make a column saying the proportion fo sum TPMTargeted P1 Isoforms over total TPM isoforms</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;proportion_TPM_P1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P1 Isoforms&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P1 Isoforms&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P2 Isoforms&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;proportion_TPM_P2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P2 Isoforms&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P1 Isoforms&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sum TPM Targeted P2 Isoforms&#39;</span><span class="p">])</span>
<span class="c1">#what i need is to plot sns.pairplot</span>
<span class="n">df_filt</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;successfulKD&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span>

<span class="c1">#read in loc+&quot;files/singlecell_shortread_analysis/differential_exp_directional_genes.csv&quot;,</span>
<span class="n">deg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;files/singlecell_shortread_analysis/differential_exp_directional_genes.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">deg</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">deg</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#merge df_clean with deg on gene and plot the significant genes</span>
<span class="c1">#sum the number of significant genes per gene per promoter irrespective of direction &quot;P1 Gene Count&quot; &quot;P2 Gene Count&quot;</span>
<span class="n">deg_summary</span> <span class="o">=</span> <span class="n">deg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;gene&#39;</span><span class="p">])[[</span><span class="s1">&#39;P1 Gene Count&#39;</span><span class="p">,</span> <span class="s1">&#39;P2 Gene Count&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_merged</span><span class="o">=</span><span class="n">df_filt</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">deg_summary</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_deg&#39;</span><span class="p">))</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">p1_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;edist_P1&#39;</span><span class="p">,</span><span class="s1">&#39;significant_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue_adj_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;promoter_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted P1 Isoforms&#39;</span><span class="p">,</span>  <span class="s1">&#39;% KD of targeted P1 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM_P1&#39;</span><span class="p">,</span><span class="s2">&quot;P1 Gene Count&quot;</span><span class="p">]</span>
<span class="n">p2_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;edist_P2&#39;</span><span class="p">,</span><span class="s1">&#39;significant_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue_adj_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;promoter_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted P2 Isoforms&#39;</span><span class="p">,</span>  <span class="s1">&#39;% KD of Targeted P2 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM_P2&#39;</span><span class="p">,</span> <span class="s2">&quot;P2 Gene Count&quot;</span><span class="p">]</span>
<span class="n">df_p1</span><span class="o">=</span><span class="n">df_merged</span><span class="p">[</span><span class="n">p1_col</span><span class="p">]</span>
<span class="n">df_p2</span><span class="o">=</span><span class="n">df_merged</span><span class="p">[</span><span class="n">p2_col</span><span class="p">]</span>
<span class="n">df_p1</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span><span class="s1">&#39;significant&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue_adj&#39;</span><span class="p">,</span> <span class="s1">&#39;promoter&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">,</span>  <span class="s1">&#39;% KD of targeted Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">]</span>
<span class="n">df_p2</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span><span class="s1">&#39;significant&#39;</span><span class="p">,</span> <span class="s1">&#39;pvalue_adj&#39;</span><span class="p">,</span> <span class="s1">&#39;promoter&#39;</span><span class="p">,</span> <span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">,</span>  <span class="s1">&#39;% KD of targeted Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span> <span class="s2">&quot;Gene_Num&quot;</span><span class="p">]</span>
<span class="n">df_melt</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_p1</span><span class="p">,</span><span class="n">df_p2</span><span class="p">])</span>
<span class="c1">#log x-axis for edist</span>
<span class="c1">#plot pairplot</span>
<span class="c1">#log10 ofsum TPM Targeted Isoforms</span>
<span class="c1">#filter above -20</span>
<span class="c1">#reset index</span>
<span class="n">df_melt</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#add correlation coefficients to the upper plots</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span>
    <span class="n">df_melt</span><span class="p">,</span>
    <span class="n">diag_kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span>
    <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">,</span>
          <span class="s1">&#39;% KD of targeted Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">],</span>
    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;promoter&#39;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;P1&quot;</span><span class="p">:</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s2">&quot;P2&quot;</span><span class="p">:</span> <span class="s1">&#39;tab:pink&#39;</span><span class="p">}</span>
<span class="p">)</span>
<span class="c1"># set x-axis to log scale for edist and sum TPM Targeted Isoforms</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;edist&#39;</span> <span class="ow">or</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;edist&#39;</span> <span class="ow">or</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">vars_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted Isoforms&#39;</span><span class="p">,</span>
             <span class="s1">&#39;% KD of targeted Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">]</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_list</span><span class="p">)</span>
<span class="n">hues</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_melt</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">palette_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;P1&quot;</span><span class="p">:</span> <span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="s2">&quot;P2&quot;</span><span class="p">:</span> <span class="s1">&#39;tab:pink&#39;</span><span class="p">}</span>

<span class="c1"># Annotate upper triangle with per-hue Pearson r, stacked to avoid overlap</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hues</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">df_melt</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">h</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">df_melt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">df_melt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">vars_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># require at least 2 finite points</span>
            <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">good</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">r_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> r: N/A&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">good</span><span class="p">])</span>
                <span class="n">r_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2"> r: </span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="mf">0.08</span>  <span class="c1"># stack vertically to avoid overlap</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">r_text</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ypos</span><span class="p">),</span>
                <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">palette_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">),</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.2&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
            <span class="p">)</span>
<span class="c1">#change the x and y labels to be Log E-distance, Log Sum TPM Targeted Isoforms, % KD of targeted Isoforms against NTC, Proportion TPM</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_28_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_28_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot TPM Non-Targeted P1 Isoforms sum TPM Non-Targeted P2 Isoforms % KD of Targeted P2 Isoforms against NTC</span>
<span class="c1">#add df</span>
<span class="n">p1_subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted P1 Isoforms&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;% KD of targeted P1 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;significant_P1&#39;</span><span class="p">]]</span>
<span class="n">p1_subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;TPM_NT&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;%KD&#39;</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">]</span>
<span class="n">p1_subset</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P1&#39;</span>
<span class="n">p2_subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;sum TPM Targeted P2 Isoforms&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;% KD of Targeted P2 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;significant_P2&#39;</span><span class="p">]]</span>
<span class="n">p2_subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;TPM_NT&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;%KD&#39;</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">]</span>
<span class="n">p2_subset</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P2&#39;</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">p1_subset</span><span class="p">,</span> <span class="n">p2_subset</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#filter successful KD only</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;successfulKD&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">][</span><span class="s1">&#39;gene&#39;</span><span class="p">])]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;TPM_NT&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;%KD&#39;</span><span class="p">,</span>  <span class="n">style</span><span class="o">=</span><span class="s1">&#39;promoter&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Sum TPM Targeted Isoforms&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;% KD of Targeted Isoforms against NTC&#39;</span><span class="p">)</span>
<span class="c1">#add correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="n">corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;TPM_NT&#39;</span><span class="p">],</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;%KD&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Pearson r: </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#save fig</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;kd_efficiency_vs_ntc_expression.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_29_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_29_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot TPM Non-Targeted P1 Isoforms sum TPM Non-Targeted P2 Isoforms % KD of Targeted P2 Isoforms against NTC</span>
<span class="c1">#add df</span>
<span class="n">p1_subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P1&#39;</span><span class="p">,</span> <span class="s1">&#39;% KD of targeted P1 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;significant_P1&#39;</span><span class="p">]]</span>
<span class="n">p1_subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span> <span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="s1">&#39;%KD&#39;</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">]</span>
<span class="n">p1_subset</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P1&#39;</span>
<span class="n">p2_subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;edist_P2&#39;</span><span class="p">,</span> <span class="s1">&#39;% KD of Targeted P2 Isoforms against NTC&#39;</span><span class="p">,</span> <span class="s1">&#39;significant_P2&#39;</span><span class="p">]]</span>
<span class="n">p2_subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span> <span class="s1">&#39;edist&#39;</span><span class="p">,</span> <span class="s1">&#39;%KD&#39;</span><span class="p">,</span> <span class="s1">&#39;significant&#39;</span><span class="p">]</span>
<span class="n">p2_subset</span><span class="p">[</span><span class="s1">&#39;promoter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;P2&#39;</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">p1_subset</span><span class="p">,</span> <span class="n">p2_subset</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#filter successful KD only</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;successfulKD&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">][</span><span class="s1">&#39;gene&#39;</span><span class="p">])]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">combined_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;proportion_TPM&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;edist&#39;</span><span class="p">,</span>  <span class="n">style</span><span class="o">=</span><span class="s1">&#39;promoter&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Proportion TPM Targeted Isoforms&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;E-distance to NTC&#39;</span><span class="p">)</span>
<span class="c1">#add correlation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span>
<span class="n">corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;proportion_TPM&#39;</span><span class="p">],</span> <span class="n">combined_df</span><span class="p">[</span><span class="s1">&#39;%KD&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Pearson r: </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
       <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#save fig</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_loc</span><span class="o">+</span><span class="s2">&quot;kd_efficiency_vs_ntc_expression.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_30_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_30_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[209]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot % KD of targeted P1 Isoforms against NTC  % KD of Targeted P2 Isoforms against NTC against MP_Gene_Num and AP_Gene_Num with Direction</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="c1">#nmelt df_merged to have one column for % KD and one for promoter type</span>
<span class="c1">#select % KD of targeted P1 Isoforms against NTC  and MP_Gene_Num and Overlap direction and add to top</span>
<span class="n">df_melted_p1</span><span class="o">=</span><span class="n">df_merged</span><span class="p">[[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;% KD of targeted P1 Isoforms against NTC&quot;</span><span class="p">,</span><span class="s2">&quot;MP_Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Direction&quot;</span><span class="p">]]</span>
<span class="n">df_melted_p1</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;% KD&quot;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span>
<span class="n">df_melted_p1</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;P1&quot;</span>
<span class="c1">#select % KD of Targeted P2 Isoforms against NTC  and AP_Gene</span>
<span class="n">df_melted_p2</span><span class="o">=</span><span class="n">df_merged</span><span class="p">[[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;% KD of Targeted P2 Isoforms against NTC&quot;</span><span class="p">,</span><span class="s2">&quot;AP_Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Direction&quot;</span><span class="p">]]</span>
<span class="n">df_melted_p2</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span><span class="s2">&quot;% KD&quot;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">,</span><span class="s2">&quot;Direction&quot;</span><span class="p">]</span>
<span class="n">df_melted_p2</span><span class="p">[</span><span class="s2">&quot;Promoter&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;P2&quot;</span>
<span class="n">df_melted</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_melted_p1</span><span class="p">,</span><span class="n">df_melted_p2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#drop nas</span>
<span class="n">df_melted</span><span class="o">=</span><span class="n">df_melted</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;% KD&quot;</span><span class="p">,</span><span class="s2">&quot;Gene_Num&quot;</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_melted</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Gene_Num&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;% KD&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Direction&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;Promoter&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;KD vs Number of DE genes by promoter type&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of DE genes (FDR&lt;0.05)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;% KD of targeted isoforms against NTC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="c1">#also add correlation coefficent</span>
<span class="k">for</span> <span class="n">promoter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;P1&#39;</span><span class="p">,</span><span class="s1">&#39;P2&#39;</span><span class="p">]:</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">df_melted</span><span class="p">[</span><span class="n">df_melted</span><span class="p">[</span><span class="s1">&#39;Promoter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">promoter</span><span class="p">]</span>
    <span class="n">corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s1">&#39;Gene_Num&#39;</span><span class="p">],</span> <span class="n">subset</span><span class="p">[</span><span class="s1">&#39;% KD&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span> <span class="k">if</span> <span class="n">promoter</span> <span class="o">==</span> <span class="s1">&#39;P1&#39;</span> <span class="k">else</span> <span class="mf">0.8</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">promoter</span><span class="si">}</span><span class="s1"> Pearson r: </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
             <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_31_0.png" src="../../_images/scripts_3_analysis_scripts_4_estatistic_gene_guide_31_0.png" />
</div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="9B_velocity_loom.html" class="btn btn-neutral float-left" title="Velocity and pyGSEA calculations of ESR1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="5_genekd_neighbouring_gene_expression.html" class="btn btn-neutral float-right" title="Target gene and neighbouring gene expression" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Helen King.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>